var initCanvas={};console.log("Enter initCanvas.js");
var cy=cytoscape({container:document.getElementById("cy"),layout:{},style:[{selector:"node",style:{label:"data(name)","text-opacity":1,"text-valign":"center","text-halign":"center","border-width":2,"border-color":"black","transition-property":"border-width, border-color","transition-duration":"0.8s"}},{selector:"edge",style:{label:"data(name)","text-background-color":"white","text-background-opacity":1,"text-border-opacity":1,"text-border-color":"#9dbaea","text-border-width":2,width:4,"target-arrow-shape":"triangle",
"line-color":"#9dbaea","target-arrow-color":"#9dbaea","curve-style":"bezier","line-style":"solid"}},{selector:".page",style:{shape:"roundrectangle","background-color":"#aaaaaa"}},{selector:".control",style:{shape:"ellipse","background-color":"#72dadb"}},{selector:".source_node",style:{"border-width":7,"border-color":"#9dbaea","transition-duration":"0.1s"}},{selector:".disconnected",style:{"border-width":7,"border-color":"red","transition-property":"border-width, border-color","transition-duration":"0.1s"}},
{selector:".start",style:{label:"Start",width:40,height:40,"background-color":"#9deaa6"}},{selector:".leaf",style:{shape:"hexagon",width:35,height:35,"background-color":"#eacd9d"}},{selector:".pageedge",style:{}},{selector:".success-edge",style:{"line-color":"#a1d490","target-arrow-color":"#a1d490"}},{selector:".fail-edge",style:{"line-color":"#c390d4","target-arrow-color":"#c390d4"}},{selector:".parent-selected",style:{"line-style":"dashed"}},{selector:":selected",style:{"text-border-color":"black",
"border-width":5,"line-color":"black","target-arrow-color":"black","transition-duration":"0.1s"}}],boxSelectionEnabled:!0,selectionType:"single",minZoom:.2,maxZoom:5});cy.panzoom();resizeCanvas();console.log("Canvas done");var assetLoad={};var project={};console.log("Entering project.js");var project_project=project_createNewProject();project_updateProject();function project_createNewProject(){return{projectOwner:"none",projectName:"none",graph:[],statTypes:[],characters:[]}}
function project_updateProject(){if("none"==project_project.projectOwner){console.log("Creating new project");project_project.projectOwner="Admin";project_project.projectName="newDemo";project_project.graph=cy.elements().jsons();project_project.statTypes.push({type:"MAGIC"});project_project.statTypes.push({type:"SPIRIT"});project_project.statTypes.push({type:"STRENGTH"});character={};for(var a=0;a<project_project.statTypes.length;a++)character[project_project.statTypes[a].type]=0;project_project.characters.push(character)}else console.log("Updating project..."),
project_project.graph=cy.elements().jsons()};var conditions={};console.log("Enter conditions.js");function conditions_createCondition(a,b,c,d){if("="!=c&&">"!=c&&"<"!=c&&">="!=c&&"<="!=c)console.log("conditions_createCondition(): invalid comparison parameter. Could not generate condition object.");else if(1==isNaN(d)||""==d)console.log("conditions_createCondition(): invalid value parameter(Not a number). Could not generate condition object.");else return{edge:a.data.id,id:getNextConditionID(a),stat:b,comparison:c,value:d}}
function conditions_createOutcome(a,b,c,d){if("+"!=c&&"-"!=c&&"/"!=c&&"*"!=c)console.log("conditions_createOutcome(): invalid modifier parameter. Could not generate outcome object.");else if(1==isNaN(d)||""==d)console.log("conditions_createOutcome(): invalid value parameter(Not a number). Could not generate outcome object.");else return{edge:a.data.id,id:getNextOutcomeID(a),stat:b,modifier:c,value:d}}
function getNextConditionID(a){for(var b=-1,c=0;c<a.data.conditions.length;c++)a.data.conditions[c].id>b&&(b=a.data.conditions[c].id);return++b}function getNextOutcomeID(a){for(var b=-1,c=0;c<a.data.outcomes.length;c++)a.data.outcomes[c].id>b&&(b=a.data.outcomes[c].id);return++b};var attributesOverlay={},attributeCount=0,attID=0;function attributesOverlay_openAttributesOverlay(){}
function attributesOverlay_addAttribute(a){var b='<li id="att-'+attID+'">  <div class="collapsible-header" id="att-'+attID+'-header">Attribute Name</div> <div class="collapsible-body"> <br/> <div class="row"> <div class="input-field col s4"> <input id="att-'+attID+'-name" type="text" class="validate"> <label for="att-'+attID+'-name">Name</label> </div> <div class="input-field col s2"> <input id="att-max-val" type="number"/> <label for="att-max-val">Max Value</label> </div> <div class="input-field col s2"> <input id="att-init-value" type="number"/> <label for="att-init-value">Initial Value</label></div>  <button class="btn btn-default" id="att-'+attID+
'" onclick="attributeOverlay_updateAttribute(this.id)">Update</button> </div> </div> </li>';$("#"+a).append(b);attributeCount++;attID++}function attributeOverlay_updateAttribute(a){var b=$("#"+a+"-name").val();$("#"+a+"-header").html(b)}function attributeOverlay_deleteAttribute(){};var httpRequests={};console.log("Enter httpRequests.js");function http_save(){console.log("save");project_updateProject();$.ajax({type:"POST",url:"/saveProject",data:{save:JSON.stringify(project_project)},success:function(a){alert("Graph Saved")},contenttype:"application/json"})}
function http_load(){console.log("Load");var a=cy.elements();cy.remove(a);$.ajax({url:"/getProject",data:{projectOwner:"Admin",projectName:"newDemo"},cache:!1,type:"GET",success:function(a){delete a[0]._id;project_project=a[0];for(var c=0;c<a[0].graph.length;c++)if("edges"==a[0].graph[c].group)cy.add(a[0].graph[c]).on("tap",function(a){this.select()});else cy.add(a[0].graph[c])},contenttype:"application/json"})}
function http_delete(a){console.log("Delete");$.ajax({type:"POST",url:"php/delete.php",data:JSON.stringify(a),success:function(a){},contentType:"application/json"})}function http_packageProject(a,b,c){a={username:a,graph:[],statTypes:[]};a.graph=b;a.statTypes=c;return a};var pageOverlay={};$(document).ready(function(){$(".modal-trigger").leanModal({dismissible:!0,ready:function(){var a=cy.$(":selected")[0];null!=a&&(a.hasClass("page")?(openEditPageOverlay(a),console.log("Opening page overlay")):a.isEdge()?(openEditConnectionOverlay(a),console.log("Opening Edge Overlay")):a.hasClass("control")&&(openEditControlOverlay(a),console.log("Opening Control Overlay")))},complete:function(){closeOverlay(null)}})});
function addDecisionContainer(a,b,c,d){b="<div id = 'decision-container' class='drag-element' style='position:absolute;'>"+("<div id = 'editdec' class = 'decisionbutton drag-element resize-element' contenteditable=true>"+escapeHtml(c)+"</div>");b+="</div>";c=a.data("decisioncontainers");c.push({name:d,html:b});a.data("decisioncontainers",c)}
function addTextContainer(){var a=cy.$(":selected")[0].data("textcontainers").length,b;b="<div id = 'text-container' class='drag-element' style='position:absolute;'><div id = 'editdiv' class='resize-element' contenteditable=true ></div></div>";var c=htmlToElements(b);$("#pagecontainers").append(c);$("#pagecontainers div#text-container:last").prepend("<div class='handle'>Text Container "+(a+1)+"</div>");c=cy.$(":selected")[0].data("textcontainers");c.push({name:a+1,html:b});cy.$(":selected")[0].data("textcontainers",
c)}
function addImageContainer(){var a,b=prompt("Enter image url","http://");if(null!=b){if(null!=b.match(/\.(jpeg|jpg|gif|png)$/))a="<div id = 'img-container' class='drag-element' style='position:absolute;'>"+("<img id = 'editdiv' class='resize-element' src="+b+"></img>")+"</div>";else if(null!=b.match(/\.(webm)$/))a="<div id = 'img-container' class='drag-element' style='position:absolute;'><video preload='auto' autoplay='autoplay' loop='loop' id = 'editdiv' class='resize-element'>",a+='<source src= "'+b+
"\"type='video/webm'></source>",a+="</video></div>";else if(null!=b.match(/\.(gifv|mp4)$/))a=b.lastIndexOf(".gifv"),-1!=a&&(b=b.substr(0,a)+".mp4",console.log("Regexed to: ",b)),a="<div id = 'img-container' class='drag-element' style='position:absolute;'><video preload='auto' autoplay='autoplay' loop='loop' id = 'editdiv' class='resize-element'>",a+='<source src= "'+b+"\"type='video/mp4'></source>",a+="</video></div>";else{alert("Not a valid url");return}var b=cy.$(":selected")[0].data("imgcontainers").length,
c=htmlToElements(a);$("#pagecontainers").append(c);$("#pagecontainers div#img-container:last").prepend("<div class='handle'>Image Container "+(b+1)+"</div>");c=cy.$(":selected")[0].data("imgcontainers");c.push({name:b+1,html:a});cy.$(":selected")[0].data("imgcontainers",c)}}function updatePageStyle(a){openEditPageOverlay(a);closeOverlay(a)}
function openEditPageOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);null===a&&overlayToolbar(b);if(b.hasClass("page")){var c=b.data("textcontainers");for(a=0;a<c.length;a++)$("#pagecontainers").append(c[a].html),$("#pagecontainers div#text-container:last").prepend("<div class='handle'>Text Container "+c[a].name+"</div>");c=b.data("imgcontainers");for(a=0;a<c.length;a++)$("#pagecontainers").append(c[a].html),$("#pagecontainers div#img-container:last").prepend("<div class='handle'>Image Container "+
c[a].name+"</div>");outgoingEdges=b.outgoers().edges();for(var c=b.data("decisioncontainers"),d=0;d<outgoingEdges.size();d++){var e=!1;for(a=0;a<c.length;a++)outgoingEdges[d].data("name")==c[a].name&&(e=!0);e||addDecisionContainer(b,d,outgoingEdges.eq(d).data("text"),outgoingEdges[d].data("name"))}for(a=0;a<c.length;a++){e=!1;for(d=0;d<outgoingEdges.size();d++)c[a].name==outgoingEdges[d].data("name")&&($("#pagecontainers").append(c[a].html),$("#pagecontainers div#decision-container:last").prepend("<div class='handle'>Link "+
c[a].name+"</div>"),e=!0);e||c.splice(a,1)}}}function openEditConnectionOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);populateEdgeOverlay(b.json())}function openEditControlOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);$("#controlcontainers #controltext").val(escapeHtml(b.data("text")));populateControlOverlay(b)}
function overlayToolbar(a){a.hasClass("control")?($("#controltoolbar").show(),$("#controlname").text("control "+a.data("id"))):a.hasClass("page")?($("#pagetoolbar").show(),$("#pagename").text("Page "+a.data("name"))):a.isEdge()&&($("#connectiontoolbar").show(),$("#connectionname").text("Connection "+a.data("name")))}
function closeOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);null!=b&&(b.hasClass("page")&&($("#pagecontainers .handle").remove(),$("#pagecontainers").children("div[id^='text-container']").each(function(a){var d=this.outerHTML;b.data("textcontainers")[a].html=d;console.log("Updating HTML for ",a)}),$("#pagecontainers").children("div[id^='decision-container']").each(function(a){var d=this.outerHTML;b.data("decisioncontainers")[a].html=d;console.log("save html for decision ",a)}),$("#pagecontainers").children("div[id^='img-container']").each(function(a){var d=
this.outerHTML;b.data("imgcontainers")[a].html=d;console.log("save html for img ",a)}),$("#pagecontainers").html("")),b.hasClass("control")&&(saveControl(b),$("#connectedEdgesList").children().remove()),b.isEdge()&&(saveEdge(b,"EDGE_OVERLAY"),$("#conditionsList").children().remove(),$("#outcomesList").children().remove()))}
function showOverlayLinks(a){$(".editbutton").hide();a.hasClass("page")?$('a[href="#page-modal"]').show():a.hasClass("control")?$('a[href="#control-modal"]').show():a.hasClass("pageedge")?$('a[href="#connection-modal"]').show():a.hasClass("controledge")&&$('a[href="#connection-modal"]').show()}function escapeHtml(a){var b=document.createElement("div");b.appendChild(document.createTextNode(a));return b.innerHTML}
function htmlToElements(a){var b=document.createElement("template");b.innerHTML=a;return b.content.childNodes};var layouts={},cose_layout={name:"cose",ready:function(){},stop:function(){},animate:!0,animationThreshold:250,refresh:1,fit:!0,padding:30,boundingBox:void 0,componentSpacing:100,nodeRepulsion:function(a){return 4E5},nodeOverlap:10,idealEdgeLength:function(a){return 10},edgeElasticity:function(a){return 100},nestingFactor:5,gravity:80,numIter:1E3,initialTemp:200,coolingFactor:.95,minTemp:1,useMultitasking:!0},concentric_layout={name:"concentric",fit:!0,padding:30,startAngle:1.5*Math.PI,sweep:void 0,
clockwise:!0,equidistant:!0,minNodeSpacing:30,boundingBox:void 0,avoidOverlap:!0,height:void 0,width:void 0,concentric:function(a){return a.degree()},levelWidth:function(a){return a.maxDegree()/4},animate:!0,animationDuration:500,animationEasing:void 0,ready:void 0,stop:void 0},grid_layout={name:"grid",fit:!0,padding:30,boundingBox:void 0,avoidOverlap:!0,avoidOverlapPadding:10,condense:!1,rows:void 0,cols:void 0,position:function(a){},sort:void 0,animate:!0,animationDuration:500,animationEasing:void 0,
ready:void 0,stop:void 0},breadth_first_layout={name:"breadthfirst",fit:!0,directed:!0,padding:30,circle:!1,spacingFactor:1.75,boundingBox:void 0,avoidOverlap:!0,roots:!1,maximalAdjustments:0,animate:!0,animationDuration:500,animationEasing:void 0,ready:void 0,stop:void 0};function style_end_nodes(){cy.elements(".leaf").removeClass("leaf");cy.$("node").successors().leaves(".page").addClass("leaf")}
function cleanup_node_labels(a){cy.remove(a);a=1;for(a;a<cy.nodes().size();a++)cy.nodes()[a].style("label",a+1),cy.nodes()[a].data("name",a+1);cy.$("node").first().addClass("start")}
function cleanup_edge_labels(a){for(var b=a.source(),c=0;c<b.data("decisioncontainers").length;c++)if(b.data("decisioncontainers")[c].name==a.data("name")){b.data("decisioncontainers").splice(c,1);break}cy.remove(a);c=0;a=b.edgesTo("*");for(c;c<a.size();c++){updatePageStyle(b);var d=String.fromCharCode("A".charCodeAt()+c);a[c].style("label",d);a[c].data("name",d);b.data("decisioncontainers")[c].name=d}}
function layout_driver(a){if("none"!=a.value){a=a.value;var b=null;"Tree"==a?b=breadth_first_layout:"Grid"==a?b=grid_layout:"Circle"==a?b=concentric_layout:"Spread"==a&&(b=cose_layout);null!==b?change_layout(b):console.log("No layout selected")}}function change_layout(a){"breadthfirst"==a.name&&(console.log("Set root"),a.roots=cy.$(".start"));cy.layout(a)};var states={DEFAULT:0,CONNECTING:1,NEWPAGE:2,NEWCONTROL:3};current_state=states.DEFAULT;function defaultState(){exitStates();current_state=states.DEFAULT}function exitStates(){current_state==states.CONNECTING&&(cy.boxSelectionEnabled(!0),null!==source_node&&(source_node.removeClass("source_node"),source_node=null));$("#sidebar .btn").removeClass("activebutton")}
function changeState(a){exitStates();$(a).addClass("activebutton");$(a).hasClass("connectionmode")&&current_state!=states.CONNECTING?(current_state=states.CONNECTING,cy.boxSelectionEnabled(!1),source_node=null,cy.$(":selected").unselect()):$(a).hasClass("pagemode")&&current_state!=states.NEWPAGE?current_state=states.NEWPAGE:$(a).hasClass("controlmode")&&current_state!=states.NEWCONTROL?current_state=states.NEWCONTROL:($(a).hasClass("deletebutton")&&removeElement(),current_state=states.DEFAULT,$(a).removeClass("activebutton"))}
;var ui={};function removeElement(){element=cy.$(":selected");element.empty()||(element.isNode()&&cleanup_node_labels(element),element.isEdge()&&(cleanup_edge_labels(element),style_end_nodes()));$(".editbutton").hide();$(".selectionbutton").hide()}
function createConnection(a){if(current_state==states.CONNECTING&&a.isNode())if(null==source_node)source_node=a,source_node.addClass("source_node"),console.log("Source node assigned as node",a.data("id"));else if(source_node.data("id")!=a.data("id")){console.log("Creating link from ",source_node.data("id")," to ",a.data("id"));var b="",c=!0;if(source_node.hasClass("control")){var d=source_node.edgesTo("*");console.log("Size from control: ",d.size());0===d.size()?b="success-edge":1===d.size()?b=d.first().hasClass("success-edge")?
"fail-edge":"success-edge":c=!0;b+=" controledge"}else source_node.hasClass("page")&&(b+="pageedge");c&&(c=String.fromCharCode("A".charCodeAt()+source_node.edgesTo("*").size()),b=cy.add({data:{name:c,source:source_node.data("id"),target:a.data("id"),text:"<Decision text to display)>",conditions:[],outcomes:[]},classes:b,group:"edges"}),b.on("tap",function(a){this.select()}),source_node.hasClass("control")&&(console.log(source_node.json()),source_node.json().data.priorityList.push(b.json().data.id)));
source_node.removeClass("source_node");source_node=null;a.unselect();style_end_nodes()}}function resizeCanvas(){var a=$(window).width(),b=$(window).height(),c=$("#tabheadings").height();$("#cy").css("width",9*a/12-30);$("#cy").css("height",b-c);$("#sidebar").css("height",b-c);console.log("We resized, width: "+a+" height: "+b);cy.resize()}$(window).resize(resizeCanvas);
var observer=new MutationObserver(function(a){a.forEach(function(a){(a.oldvalue="block"==a.target.style.display)&&cy.resize()})}),cytabNode=$("#cyTab")[0],observerConfig={attributes:!0,childList:!1,characterData:!1,attributeOldValue:!0,attributeFilter:["style"]};observer.observe(cytabNode,observerConfig);var canvasEvents={};console.log("Enter canvasEvents.js");source_node=null;
cy.on("tap",function(a){var b=a.cyTarget;b===cy&&cy.$(":selected").unselect();current_state!==states.CONNECTING||b!==source_node&&b!==cy||null===source_node||(source_node.removeClass("source_node"),source_node=null);current_state===states.NEWPAGE?(console.log("Add a node"),b===cy&&(console.log("Really Add a node"),cy.add({data:{name:cy.nodes().size()+1,imgcontainers:[],audio:"none",textcontainers:[],decisioncontainers:[],styleHTML:""},classes:"page",group:"nodes",renderedPosition:a.cyRenderedPosition})),
1===cy.elements().size()&&cy.$("node").first().addClass("start")):current_state===states.NEWCONTROL&&b===cy&&cy.add({data:{name:cy.nodes().size()+1,text:"control node text",priorityList:[]},classes:"control",group:"nodes",renderedPosition:a.cyRenderedPosition})});
cy.on("select",function(a){a.cyTarget.isNode()&&a.cyTarget.outgoers().addClass("parent-selected");console.log("Select event fired ",a.cyTarget.data("id"));current_state===states.CONNECTING?(a.cyTarget.isEdge()&&(defaultState(),showOverlayLinks(a.cyTarget)),cy.$(":selected").diff(a.cyTarget).left.unselect(),createConnection(a.cyTarget)):showOverlayLinks(a.cyTarget);$(".selectionbutton").show()});
cy.on("unselect",function(a){a.cyTarget.isNode()&&a.cyTarget.outgoers().removeClass("parent-selected");console.log("Unselect event fired ",a.cyTarget.data("id"));0===cy.$(":selected").size()?($(".editbutton").hide(),$(".selectionbutton").hide()):showOverlayLinks(cy.$(":selected")[0])});var edgeOverlay={},edgeOverlay_newConditionCount=0,edgeOverlay_newOutcomeCount=0,edgeOverlay_selectedEdge;function populateEdgeOverlay(a){edgeOverlay_newOutcomeCount=edgeOverlay_newConditionCount=0;edgeOverlay_selectedEdge=a;for(var b=0;b<a.data.conditions.length;b++){var c=a.data.conditions[b];console.log(c);edgeOverlay_addExistingCondition("conditionsList",c)}for(b=0;b<a.data.outcomes.length;b++)c=a.data.outcomes[b],edgeOverlay_addExistingOutcome("outcomesList",c)}
function saveEdge(a,b){for(var c=a.json(),d=0;d<c.data.conditions.length;d++){var e=c.data.conditions[d],f="exCondition_"+e.edge+"_"+e.id;0!==$("#"+f+"_statTypeList").length&&(e.stat=$("#"+f+"_statTypeList").val(),e.comparison=$("#"+f+"_compList").val(),e.value=$("#"+f+"_value").val())}for(d=0;d<c.data.outcomes.length;d++)e=c.data.outcomes[d],f="exOutcome_"+e.edge+"_"+e.id,0!==$("#"+f+"_statTypeList").length&&(e.stat=$("#"+f+"_statTypeList").val(),e.modifier=$("#"+f+"_modList").val(),e.value=$("#"+
f+"_value").val());if("EDGE_OVERLAY"===b){for(d=0;d<edgeOverlay_newConditionCount;d++){var e=$("#newCondition_statTypeList"+d).val(),g=$("#newCondition_compList"+d).val(),f=$("#newCondition_value"+d).val(),e=conditions_createCondition(c,e,g,f);console.log(e);void 0!==e&&c.data.conditions.push(e)}for(d=0;d<edgeOverlay_newOutcomeCount;d++)e=$("#newOutcome_statTypeList"+d).val(),g=$("#newOutcome_modList"+d).val(),f=$("#newOutcome_value"+d).val(),e=conditions_createOutcome(c,e,g,f),console.log(e),void 0!==
e&&c.data.outcomes.push(e)}edgeOverlay_newOutcomeCount=edgeOverlay_newConditionCount=0}function populateStatsDropDownMenu(a){a="#"+a;for(var b=0;b<project_project.statTypes.length;b++)$(a).append('<option value="'+project_project.statTypes[b].type+'">'+project_project.statTypes[b].type+"</option>"),$(a).material_select()}
function edgeOverlay_addNewCondition(a){var b='<li id="newCondition_'+edgeOverlay_newConditionCount+'"><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 3%"><select id="newCondition_statTypeList'+edgeOverlay_newConditionCount+'"></select></div><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 1%; padding-right: 1%;"><select id="newCondition_compList'+edgeOverlay_newConditionCount+'"><option value=">">></option><option value="<"><</option><option value=">=">>=</option><option value="<="><=</option><option value="=">=</option></select></div><input placeholder="Enter Value" id="newCondition_value'+
edgeOverlay_newConditionCount+'" type="number" class="validate" style = "display: inline-block; width: 20%;"><div id="DummyDiv" class="input-field col s12" style = "display: inline-block; width: 30%;"></div><a id="newCondition_delete'+edgeOverlay_newConditionCount+'" class="btn-floating btn waves-effect waves-light red" onclick=removeCondition(\'newCondition_'+edgeOverlay_newConditionCount+'\')><i class="material-icons">delete</i></a></li>';$("#"+a).append(b);$("#newCondition_"+edgeOverlay_newConditionCount).hide(0,
function(){$("#newCondition_"+edgeOverlay_newConditionCount).show(300)});$("#newCondition_statTypeList"+edgeOverlay_newConditionCount).material_select();$("#newCondition_compList"+edgeOverlay_newConditionCount).material_select();populateStatsDropDownMenu("newCondition_statTypeList"+edgeOverlay_newConditionCount);edgeOverlay_newConditionCount++}
function edgeOverlay_addNewOutcome(a){var b="<li id= newOutcome_"+edgeOverlay_newOutcomeCount+'><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 3%"><select id="newOutcome_statTypeList'+edgeOverlay_newOutcomeCount+'"></select></div><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 1%; padding-right: 1%;"><select id="newOutcome_modList'+edgeOverlay_newOutcomeCount+'"><option value="+">+</option><option value="-">-</option><option value="*">*</option><option value="/">/</option><option value="=">=</option></select></div><input placeholder="Enter Value" id="newOutcome_value'+
edgeOverlay_newOutcomeCount+'" type="number" class="validate" style = "display: inline-block; width: 20%;"><div id="DummyDiv" class="input-field col s12" style = "display: inline-block; width: 30%;"></div><a id="newOutcome_delete'+edgeOverlay_newOutcomeCount+'" class="btn-floating btn waves-effect waves-light red" onclick=removeOutcome(\'newOutcome_'+edgeOverlay_newOutcomeCount+'\')><i class="material-icons">delete</i></a></li>';$("#"+a).append(b);$("#newOutcome_"+edgeOverlay_newOutcomeCount).hide(0,
function(){$("#newOutcome_"+edgeOverlay_newOutcomeCount).show(300)});$("#newOutcome_statTypeList"+edgeOverlay_newOutcomeCount).material_select();$("#newOutcome_modList"+edgeOverlay_newOutcomeCount).material_select();populateStatsDropDownMenu("newOutcome_statTypeList"+edgeOverlay_newOutcomeCount);edgeOverlay_newOutcomeCount++}
function edgeOverlay_addExistingCondition(a,b){var c="exCondition_"+b.edge+"_"+b.id,d='<li id="'+c+'"><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 3%"><select id="'+c+'_statTypeList"></select></div><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 1%; padding-right: 1%;"><select id="'+c+'_compList"><option value=">">></option><option value="<"><</option><option value=">=">>=</option><option value="<="><=</option><option value="=">=</option></select></div><input placeholder="Enter Value" id="'+
c+'_value" type="number" class="validate" style = "display: inline-block; width: 20%;"><div id="DummyDiv" class="input-field col s12" style = "display: inline-block; width: 30%;"></div><a id="'+c+'_delete" class="btn-floating btn waves-effect waves-light red" onclick=removeCondition(\''+c+'\')><i class="material-icons">delete</i></a></li>';$("#"+a).append(d);$("#"+c+"_statTypeList").material_select();$("#"+c+"_compList").material_select();populateStatsDropDownMenu(c+"_statTypeList");$("#"+c+"_statTypeList").val(b.stat);
$("#"+c+"_compList").val(b.comparison);$("#"+c+"_value").val(b.value);$("#"+c+"_statTypeList").material_select();$("#"+c+"_compList").material_select();$("#"+c).hide(0,function(){$("#"+c).show(300)})}
function edgeOverlay_addExistingOutcome(a,b){var c="exOutcome_"+b.edge+"_"+b.id,d="<li id="+c+'><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 3%"><select id="'+c+'_statTypeList"></select></div><div class="input-field col s12" style = "display: inline-block; width: 20%; padding-left: 1%; padding-right: 1%;"><select id="'+c+'_modList"><option value="+">+</option><option value="-">-</option><option value="*">*</option><option value="/">/</option><option value="=">=</option></select></div><input placeholder="Enter Value" id="'+
c+'_value" type="number" class="validate" style = "display: inline-block; width: 20%;"><div id="DummyDiv" class="input-field col s12" style = "display: inline-block; width: 30%;"></div><a id="'+c+'_delete" class="btn-floating btn waves-effect waves-light red" onclick=removeOutcome(\''+c+'\')><i class="material-icons">delete</i></a></li>';$("#"+a).append(d);$("#"+c+"_statTypeList").material_select();$("#"+c+"_modList").material_select();populateStatsDropDownMenu(c+"_statTypeList");$("#"+c+"_statTypeList").val(b.stat);
$("#"+c+"_modList").val(b.modifier);$("#"+c+"_value").val(b.value);$("#"+c+"_statTypeList").material_select();$("#"+c+"_modList").material_select();$("#"+c).hide(0,function(){$("#"+c).show(300)})}
function removeCondition(a){$("#"+a).hide(300,function(){$("#"+a).remove()});var b=a.split("_");if("newCondition"!==b[0])if("exCondition"===b[0])for(var c=cy.edges("[id='"+b[1]+"']").json(),d=0;d<c.data.conditions.length;d++)d===parseInt(b[2])&&c.data.conditions.splice(d,1);else console.log("removeCondition(): error in id formatting")}
function removeOutcome(a){console.log("Removing outcome "+a);$("#"+a).hide(300,function(){$("#"+a).remove()});var b=a.split("_");if("newOutcome"!==b[0])if("exOutcome"===b[0])for(var c=cy.edges("[id='"+b[1]+"']").json(),d=0;d<c.data.outcomes.length;d++)d===parseInt(b[2])&&c.data.outcomes.splice(d,1);else console.log("removeOutcome(): error in id formatting")};var controlOverlay={},currentDraggedItem=resetCurentDraggedItem(),currentHoverOver=null;
function populateControlOverlay(a){currentDraggedItem=resetCurentDraggedItem();currentHoverOver=null;for(var b=0;b<a.json().data.priorityList.length;b++){var c=cy.edges("[id='"+a.json().data.priorityList[b]+"']").json(),d="<li id=connectedEdge_"+c.data.id+' ><div id="header_'+c.data.id+'" draggable="true" ondragend=handleDragEnd(event) ondrag=handleDrag(event,\''+c.data.name+'\') ondragenter=handleDragEnter(event) class="collapsible-header">Edge '+c.data.name+'</div><div class="collapsible-body"><ul id = "'+
c.data.id+'_collapsible" class="collapsible" data-collapsible="expandable"><li><div class="collapsible-header">Conditions for '+c.data.name+'</div><div class="collapsible-body"><ul id = "controlConditions_'+c.data.id+'" class="list-unstyled" ></ul></div></li><li><div class="collapsible-header">Outcomes for '+c.data.name+'</div><div class="collapsible-body"><ul id = "controlOutcomes_'+c.data.id+'" class="list-unstyled" ></ul></div></li></ul></div></li>';$("#connectedEdgesList").append(d);$("#"+c.data.id+
"_collapsible").collapsible({accordion:!1});for(d=0;d<c.data.conditions.length;d++)edgeOverlay_addExistingCondition("controlConditions_"+c.data.id,c.data.conditions[d]);for(d=0;d<c.data.outcomes.length;d++)edgeOverlay_addExistingOutcome("controlOutcomes_"+c.data.id,c.data.outcomes[d])}}function saveControl(a){a.connectedEdges().forEach(function(a){saveEdge(a,"CONTROL_OVERLAY")});updatePriority(a)}
function handleDrag(a,b){currentDraggedItem.ID=a.target.id;currentDraggedItem.parentID="connectedEdge_"+a.target.id.split("_")[1];currentDraggedItem.name=b}
function handleDragEnter(a){var b='<li id="dropZoneOuter"><div id="dropZone" class="collapsible-header" ondrop=handleDrop(event) ondragover=allowDrop(event) style="font-style: italic; background-color: gray; opacity: 0.25;"> Edge '+currentDraggedItem.name+"</div></li>";currentHoverOver!==a.target.id&&(console.log(a.target.id),currentHoverOver=a.target.id,"dropZone"!==a.target.id.split("_")[0]&&($("#dropZoneOuter").remove(),"connectedEdgesList"===a.target.id?(a=$("ul#connectedEdgesList li:first").attr("id").split("_")[1],
$("#connectedEdge_"+a).before(b)):$("#connectedEdge_"+a.target.id.split("_")[1]).after(b),$("#dropZone").hide(),$("#"+currentDraggedItem.ID).hide(300,function(){$("#dropZone").show(300)})))}
function handleDrop(a){a=$("#"+currentDraggedItem.parentID).clone();$("#"+currentDraggedItem.parentID).remove();$("#dropZoneOuter").replaceWith(a);$("#"+currentDraggedItem.parentID.split("_")[1]+"_collapsible").collapsible({accordion:!1});$("#"+currentDraggedItem.ID).css("display","block");currentHoverOver=null}function allowDrop(a){a.preventDefault()}function handleDragEnd(a){$("#dropZone").hide(300,function(){$("#"+currentDraggedItem.ID).show(300)})}
function resetCurentDraggedItem(){return ret={parentID:"null",ID:"null",name:"null"}}function updatePriority(a){console.log(a.connectedEdges().jsons());a=a.json().data.priorityList;var b=[];$("#connectedEdgesList li").each(function(a,c){var f=$(c).attr("id");void 0!==f&&(f=f.split("_"),"connectedEdge"===f[0]&&b.push(f[1]))});if(a.length===b.length)for(var c=0;c<a.length;c++)a[c]=b[c]};var dragDrop={};grid_snapping_mode=!1;var grid_targets=interact.createSnapGrid({x:10,y:10,range:10,offset:{x:-2,y:2}});function initSnapOptions(){return grid_snapping_mode?{targets:[grid_targets],relativePoints:[{x:1,y:1}],endOnly:!1}:{targets:[],relativePoints:[{x:1,y:1}],endOnly:!1}}var snap_options=initSnapOptions();
function setInteractions(){interact(".drag-element:not([locked])").draggable({snap:snap_options,inertia:!1,restrict:{restriction:"parent",endOnly:!1,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!0,onmove:dragMoveListener,onend:function(a){console.log(a)}}).allowFrom(".handle");interact(".resize-element").resizable({snap:snap_options,edges:{left:!1,right:!0,bottom:!0,top:!1},onend:function(){console.log("End resize")}}).on("resizemove",function(a){var b=a.target;b.style.width=checkBounds(b.parentNode.getAttribute("data-x"),
a.rect.width,$("#pagecontainers").width())+"px";b.style.height=checkBounds(b.parentNode.getAttribute("data-y"),a.rect.height,$("#pagecontainers").height()-$(".handle").height())+"px"})}setInteractions();function toggleGridMode(){grid_snapping_mode=!grid_snapping_mode;$(".gridmode").toggleClass("activebutton");snap_options=initSnapOptions();setInteractions()}
function checkBounds(a,b,c){a=parseFloat(a)||0;console.log("Check "+a+" + "+b);a+b>c?(console.log("Greater than "+c),b=c-a):console.log("Less than "+c);return b}function dragMoveListener(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx;a=(parseFloat(b.getAttribute("data-y"))||0)+a.dy;b.style.webkitTransform=b.style.transform="translate("+c+"px, "+a+"px)";b.setAttribute("data-x",c);b.setAttribute("data-y",a)}window.dragMoveListener=dragMoveListener;var doit;
window.onresize=function(){clearTimeout(doit);doit=setTimeout(modalBounds,300)};function modalBounds(){$("#page-modal").hasClass("open")&&$(".resize-element").each(function(){console.log("Test resize");var a=$(this);a.width(checkBounds(a.parent().attr("data-x"),a.width(),$("#pagecontainers").width()));a.height(checkBounds(a.parent().attr("data-y"),a.height(),$("#pagecontainers").height()-$(".handle").height()))})};var playGame={};outgoingEdges=currentNode=null;function prepareForGame(){outgoingEdges=currentNode=null;$(".playpage").html("");for(var a=cy.elements(),b=0;b<a.length;b++)updatePageStyle(a[b])}function parseNode(){console.log("Parse node ",currentNode.data("id"));outgoingEdges=currentNode.outgoers().edges();currentNode.hasClass("page")?parsePage(outgoingEdges):currentNode.hasClass("control")&&parseControl(currentNode,outgoingEdges)}function parsePage(a){stylePage()}
function stylePage(){$(".playpage").html("");for(var a=currentNode.data("textcontainers"),b=currentNode.data("decisioncontainers"),c=currentNode.data("imgcontainers"),d=0;d<a.length;d++)$(".playpage").append(a[d].html);for(d=0;d<c.length;d++)$(".playpage").append(c[d].html);for(d=0;d<b.length;d++)$(".playpage").append(b[d].html);$(".playpage").children("div[id^='decision-container']").each(function(a){$(this).click(function(){progressStory(a)})});$(".playpage .handle").hide();$(".playpage").children().removeClass("resize-element");
$(".playpage").children().children().removeClass("resize-element");$(".playpage").children().attr("contenteditable","false");$(".playpage").children().children().attr("contenteditable","false")}
function parseControl(a,b){console.log("At control node. possible edges are: "+a.json().data.priorityList);for(var c=a.json().data.priorityList,d=-1,e=0;e<c.length;e++)!0===assessEdge(c[e])?(-1===d&&(d=e),console.log("edge "+cy.edges("[id='"+c[e]+"']").json().data.name+" is a valid path")):console.log("edge "+cy.edges("[id='"+c[e]+"']").json().data.name+" is an invalid path");e=null;-1!==d&&(e=c[d]);d=null;null!==e?d=getIndexFromOutgoingEdges(e,b):(d=getIndexFromOutgoingEdges(c[0],b),console.log("All edges from control node "+
a.json().data.name+" have evaluated false. Following default fail edge..."));-1!==d?progressStory(d):(progressStory(0),console.log("parseControl(): invalid edge id. progressing to first edge in outgoingEdges"))}function getIndexFromOutgoingEdges(a,b){for(var c=b.jsons(),d=0;d<c.length;d++)if(c[d].data.id===a)return d;return-1}
function assessEdge(a){a=cy.edges("[id='"+a+"']");console.log("Assessing edge "+a.json().data.name);if(void 0!==a){var b=a.json().data.conditions;a=[];for(var c=project_project.characters[0],d=0;d<b.length;d++){var e=b[d];switch(e.comparison){case "=":parseInt(c[e.stat])===parseInt(e.value)?a[d]=!0:a[d]=!1;break;case "!=":parseInt(c[e.stat])!==parseInt(e.value)?a[d]=!0:a[d]=!1;break;case ">":parseInt(c[e.stat])>parseInt(e.value)?a[d]=!0:a[d]=!1;break;case "<":parseInt(c[e.stat])<parseInt(e.value)?
a[d]=!0:a[d]=!1;break;case ">=":parseInt(c[e.stat])>=parseInt(e.value)?a[d]=!0:a[d]=!1;break;case "<=":parseInt(c[e.stat])<=parseInt(e.value)?a[d]=!0:a[d]=!1}!0===a[d]?console.log("Condition '"+e.stat+" "+e.comparison+" "+e.value+"' is true"):console.log("Condition '"+e.stat+" "+e.comparison+" "+e.value+"' is false")}b=!0;for(c=0;c<a.length;c++)!1===a[c]&&(b=!1);0===b.length&&(b=!1);return b}console.log("assessEdge(): invalid edge. unable to assess");return!1}
function progressStory(a){null===currentNode?(currentNode=cy.$(".start")[0],parseNode()):0<currentNode.outgoers().size()?(currentNode=outgoingEdges.eq(a).target(),console.log("Now on node ",currentNode.data("id")),parseNode()):(currentNode=null,$(".playpage").html(""))}function stripDraggable(a){return a.replace(/drag-element/g,"")};console.log("Enter main.js version 0.5.0");$("select").material_select();var testgraph={};function checkValidGraph(){var a="";cy.$(".start").hasClass("page")||(a=a.concat("Starting class must be a page node\n"));testConnectivity()||(a=a.concat("Graph is NOT connected\n"));""==a?alert("All tests passed"):alert(a)}
function testConnectivity(){var a=!1,b=cy.$("node").first(),c=cy.$("node");console.log("Root node: "+b.data("id"));var d=cy.collection(),d=d.add(b);cy.elements().dfs({roots:b,visit:function(a,b,c){d=d.add(c);console.log("visit "+this.id()+" total "+a)},directed:!0});console.log("Total nodes:"+c.size()+" Connected_nodes: "+d.size());if(c.size()==d.size())a=!0;else{var e=c.diff(d).left;console.log("Disconnected:",e.size());console.log("left: "+e.map(function(a){return a.id()}).join(", "));e.addClass("disconnected");
setTimeout(function(){e.removeClass("disconnected")},3E3)}return a};
