var initCanvas={};console.log("Enter initCanvas.js");total_pages=0;
var cy=cytoscape({container:document.getElementById("cy"),layout:{},style:[{selector:"node",style:{content:"data(name)","text-opacity":1,"text-valign":"center","text-halign":"center","border-width":1,"border-color":"black","transition-property":"border-width, border-color","transition-duration":"0.8s"}},{selector:"edge",style:{width:4,"target-arrow-shape":"triangle","line-color":"#9dbaea","target-arrow-color":"#9dbaea","curve-style":"bezier","line-style":"solid"}},{selector:".page",style:{shape:"roundrectangle",
"background-color":"gray"}},{selector:".control",style:{shape:"ellipse","background-color":"#72dadb"}},{selector:".source_node",style:{"border-width":7,"border-color":"#9dbaea","transition-duration":"0.1s"}},{selector:".disconnected",style:{"border-width":7,"border-color":"red","transition-property":"border-width, border-color","transition-duration":"0.1s"}},{selector:".start",style:{content:"Start","background-color":"#9deaa6"}},{selector:".leaf",style:{"background-color":"#eacd9d","transition-property":"background-color",
"transition-duration":"0.1s"}},{selector:".success-edge",style:{"line-color":"#a1d490","target-arrow-color":"#a1d490"}},{selector:".fail-edge",style:{"line-color":"#c390d4","target-arrow-color":"#c390d4"}},{selector:".parent-selected",style:{"line-style":"dashed"}},{selector:":selected",style:{"border-width":5,"line-color":"black","target-arrow-color":"black","transition-duration":"0.1s"}}],boxSelectionEnabled:!0,selectionType:"single",minZoom:.2,maxZoom:5});cy.panzoom();resizeCanvas();console.log("Canvas done");var assetLoad={};
function addTextContainer(){var a=cy.$(":selected").data("textcontainers").length,b=document.createElement("div");b.className="drag-element";b.id="text-container"+a;b.setAttribute("height","40");b.setAttribute("width","25%");var c=document.createElement("textarea");c.setAttribute("id","text-area"+a);c.setAttribute("rows","4");c.setAttribute("cols","30");c.setAttribute("class","text-area");b.appendChild(c);$("#pagecontainers").append(b);b=cy.$(":selected").data("textcontainers");c={id:"test",contents:"none",
html:$("#text-container"+a)[0].outerHTML};b.push(c);cy.$(":selected").data("textcontainers",b);$("#text-area"+a).on("input",function(b){b=this.value;console.log("Text: ",b);cy.$(":selected").data("textcontainers")[a].contents=b})}function loadAudio(){var a=prompt("Enter audio url",cy.$(":selected").data("audio"));null!=a&&(cy.$(":selected").data("audio",a),$("#audio").attr("src",cy.$(":selected").data("audio")))}
function toggleAudio(){0==$("#audio")[0].paused?$("#audio")[0].pause():$("#audio")[0].play()}function changeAudio(a){var b=a;null===a&&(b=cy.$(":selected"));$("#audio")[0].pause();"none"==b.data("audio")?console.log("no audio link"):$("#audio").attr("src",b.data("audio"))}
function loadImage(){console.log("Image: ",cy.$(":selected").data("id"));console.log(cy.$(":selected").data("img"));var a=prompt("Enter image url",cy.$(":selected").data("img"));null!=a&&(cy.$(":selected").data("img",a),$("#pageimg").attr("src",cy.$(":selected").data("img")),resizeImage(100,100))}
function changeImage(a){var b=a;null===a&&(b=cy.$(":selected"));"none"==b.data("img")?(resizeImage(0,0),console.log("no image link found")):($("#pageimg").attr("src",b.data("img")),resizeImage(100,100))}function resizeImage(a,b){$("#pageimg").attr("width",a);$("#pageimg").attr("height",b);resizeCanvas()};var project={};console.log("Entering project.js");var project_project={};function project_createNewProject(){project_project={projectOwner:"Admin",projectName:"newTest",graph:[],statTypes:[]};project_project.statTypes.push({type:"MAGIC"});project_project.statTypes.push({type:"SPIRIT"});project_project.statTypes.push({type:"STRENGTH"})}function project_updateProject(){project_project.graph=cy.elements().jsons()};var httpRequests={};console.log("Enter httpRequests.js");var http_modStack=[];function http_save(){console.log("save");project_createNewProject();project_updateProject();console.log(JSON.stringify(project_project));$.ajax({type:"POST",url:"/saveProject",data:{save:JSON.stringify(project_project),deletedObjects:JSON.stringify(http_modStack)},success:function(a){alert("Graph Saved")},contenttype:"application/json"})}
function http_load(){console.log("Load");var a=cy.elements();cy.remove(a);$.ajax({url:"/getProject",data:{projectOwner:"Admin",projectName:"newTest"},cache:!1,type:"GET",success:function(a){for(var c=0;c<a.length;c++)if("edges"==a[c].group)cy.add(a[c]).on("tap",function(a){this.select()});else cy.add(a[c])},contenttype:"application/json"})}
function http_delete(a){console.log("Delete");$.ajax({type:"POST",url:"php/delete.php",data:JSON.stringify(a),success:function(a){},contentType:"application/json"})}function http_packageProject(a,b,c){a={username:a,graph:[],statTypes:[]};a.graph=b;a.statTypes=c;return a};var layouts={},cose_layout={name:"cose",ready:function(){},stop:function(){},animate:!0,animationThreshold:250,refresh:1,fit:!0,padding:30,boundingBox:void 0,componentSpacing:100,nodeRepulsion:function(a){return 4E5},nodeOverlap:10,idealEdgeLength:function(a){return 10},edgeElasticity:function(a){return 100},nestingFactor:5,gravity:80,numIter:1E3,initialTemp:200,coolingFactor:.95,minTemp:1,useMultitasking:!0},concentric_layout={name:"concentric",fit:!0,padding:30,startAngle:1.5*Math.PI,sweep:void 0,
clockwise:!0,equidistant:!0,minNodeSpacing:30,boundingBox:void 0,avoidOverlap:!0,height:void 0,width:void 0,concentric:function(a){return a.degree()},levelWidth:function(a){return a.maxDegree()/4},animate:!0,animationDuration:500,animationEasing:void 0,ready:void 0,stop:void 0},grid_layout={name:"grid",fit:!0,padding:30,boundingBox:void 0,avoidOverlap:!0,avoidOverlapPadding:10,condense:!1,rows:void 0,cols:void 0,position:function(a){},sort:void 0,animate:!0,animationDuration:500,animationEasing:void 0,
ready:void 0,stop:void 0},breadth_first_layout={name:"breadthfirst",fit:!0,directed:!0,padding:30,circle:!1,spacingFactor:1.75,boundingBox:void 0,avoidOverlap:!0,roots:!1,maximalAdjustments:0,animate:!0,animationDuration:500,animationEasing:void 0,ready:void 0,stop:void 0};function cleanup_titles(){var a=1;for(a;a<cy.nodes().size();a++)cy.nodes()[a].style("content",a+1),cy.nodes()[a].data("name",a+1);cy.$("node").first().addClass("start")}
function layout_driver(a){if("none"!=a.value){a=a.value;var b=null;"Tree"==a?b=breadth_first_layout:"Grid"==a?b=grid_layout:"Circle"==a?b=concentric_layout:"Spread"==a&&(b=cose_layout);null!==b?change_layout(b):console.log("No layout selected")}}function change_layout(a){cleanup_titles();"breadthfirst"==a.name&&(console.log("Set root"),a.roots=cy.$(".start"));cy.layout(a)};var states={DEFAULT:0,CONNECTING:1,NEWPAGE:2,NEWCONTROL:3};current_state=states.DEFAULT;function exitStates(){current_state==states.CONNECTING&&(cy.boxSelectionEnabled(!0),null!==source_node&&(source_node.removeClass("source_node"),source_node=null))}
function changeState(a){exitStates();$("#sidebar .button").removeClass("activebutton");$(a).addClass("activebutton");$(a).hasClass("connectionmode")&&current_state!=states.CONNECTING?(current_state=states.CONNECTING,cy.boxSelectionEnabled(!1),source_node=null,cy.$(":selected").unselect()):$(a).hasClass("pagemode")&&current_state!=states.NEWPAGE?current_state=states.NEWPAGE:$(a).hasClass("controlmode")&&current_state!=states.NEWCONTROL?current_state=states.NEWCONTROL:($(a).hasClass("deletebutton")&&
removeElement(),current_state=states.DEFAULT,$(a).removeClass("activebutton"))};var pageOverlay={};
function showPageOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);$(".toolbar").hide();$("#modalcontainers").children().hide();overlayToolbar(b);if(b.hasClass("page")){$("#pagecontainers").show();$("#pagecontainers").html("");for(var c=cy.$(":selected")[0].data("textcontainers"),d=0;d<c.length;d++)$("#pagecontainers").append(c[d].html),$("#text-area"+d).val(escapeHtml(c[d].contents)).on("input",function(a){a=this.value;var b=this.id.replace("text-area","");console.log("Text: ",a," for ",b);cy.$(":selected").data("textcontainers")[b].contents=
a}),console.log("Display:",escapeHtml(c[d].contents));outgoingEdges=b.outgoers().edges();for(c=0;c<outgoingEdges.size();c++)$("#pagecontainers").append("<button class = 'decisionbutton drag-element' id='decision"+c+"'>"+escapeHtml(outgoingEdges.eq(c).data("text"))+"</button><br>")}b.isEdge()&&($("#connectioncontainers").show(),$("#connectioncontainers #decisiontext").val(escapeHtml(b.data("text"))));b.hasClass("control")&&($("#controlcontainers").show(),$("#controlcontainers #controltext").val(escapeHtml(b.data("text"))));
null===a&&document.getElementById("Modal").showModal()}function overlayToolbar(a){a.hasClass("control")?($("#controltoolbar").show(),$("#controlname").text("control "+a.data("id"))):a.hasClass("page")?($("#pagetoolbar").show(),$("#pagename").text("Page "+a.data("id")),changeImage(a),changeAudio(a)):a.isEdge()&&($("#connectiontoolbar").show(),$("#connectionname").text("Connection"))}
function closeOverlay(a){null===a&&document.getElementById("Modal").close();var b=a;null===a&&(b=cy.$(":selected")[0]);b.hasClass("page")&&$("#pagecontainers").children("div[id^='text-container']").each(function(a){var d=this.outerHTML;b.data("textcontainers")[a].html=d;console.log("Updating HTML for ",a)})}function escapeHtml(a){var b=document.createElement("div");b.appendChild(document.createTextNode(a));return b.innerHTML};var ui={};function removeElement(){element=cy.$(":selected");if(!element.empty()){for(var a=0;a<element.connectedEdges().jsons().length;a++)http_modStack.push(element.connectedEdges().jsons()[a]);for(a=0;a<element.jsons().length;a++)http_modStack.push(element.jsons()[a]);cy.remove(element);total_pages--;cleanup_titles();cy.$("node").first().addClass("start")}}
function createConnection(a){if(current_state==states.CONNECTING&&a.isNode())if(null==source_node)source_node=a,source_node.addClass("source_node"),console.log("Source node assigned as node",a.data("id"));else if(source_node.data("id")!=a.data("id")){console.log("Creating link from ",source_node.data("id")," to ",a.data("id"));var b="",c=!0;if(source_node.hasClass("control")){var d=source_node.edgesTo("*");console.log("Size from control: ",d.size());0===d.size()?b="success-edge":1===d.size()?b=d.first().hasClass("success-edge")?
"fail-edge":"success-edge":c=!1}if(c)cy.add({data:{source:source_node.data("id"),target:a.data("id"),text:"<Decision text to display)>"},classes:b,group:"edges"}).on("tap",function(a){this.select()});source_node.removeClass("source_node");source_node=null;a.unselect()}}
function resizeCanvas(){var a=$(window).width(),b=$(window).height(),c=$("#tabheadings").height();$("#cy").css("width",9*a/12-30);$("#cy").css("height",b-c);$("#sidebar").css("height",b-c);console.log("We resized, width: "+a+" height: "+b);cy.resize()}$(window).resize(resizeCanvas);
var observer=new MutationObserver(function(a){a.forEach(function(a){"tab-pane fade"==a.oldValue&&"tab-pane fade active in"==a.target.className&&cy.resize()})}),cytabNode=$("#cyTab")[0],observerConfig={attributes:!0,childList:!1,characterData:!1,attributeOldValue:!0,attributeFilter:["class"]};observer.observe(cytabNode,observerConfig);var canvasEvents={};console.log("Enter canvasEvents.js");source_node=null;
cy.on("tap",function(a){var b=a.cyTarget;b===cy&&cy.$(":selected").unselect();current_state!==states.CONNECTING||b!==source_node&&b!==cy||null===source_node||(source_node.removeClass("source_node"),source_node=null);current_state===states.NEWPAGE?(console.log("Add a node"),b===cy&&(console.log("Really Add a node"),cy.add({data:{name:++total_pages,text:"page text",img:"none",audio:"none",textcontainers:[],decisioncontainers:[],styleHTML:""},classes:"page",group:"nodes",renderedPosition:a.cyRenderedPosition})),
1===cy.elements().size()&&cy.$("node").first().addClass("start")):current_state===states.NEWCONTROL&&b===cy&&cy.add({data:{name:++total_pages,text:"control node text"},classes:"control",group:"nodes",renderedPosition:a.cyRenderedPosition})});
cy.on("select",function(a){a.cyTarget.isNode()&&(a.cyTarget.outgoers().addClass("parent-selected"),a.cyTarget.successors().leaves().addClass("leaf"));console.log("Select event fired ",a.cyTarget.data("id"));current_state===states.CONNECTING&&(cy.$(":selected").diff(a.cyTarget).left.unselect(),createConnection(a.cyTarget));$(".selectionbutton").show()});
cy.on("unselect",function(a){a.cyTarget.isNode()&&(a.cyTarget.outgoers().removeClass("parent-selected"),a.cyTarget.successors().leaves().removeClass("leaf"));console.log("Unselect event fired ",a.cyTarget.data("id"));0===cy.$(":selected").size()&&$(".selectionbutton").hide()});var conditions={};console.log("Enter conditions.js");function conditions_createCondition(a,b,c){if("="!=b&&">"!=b&&"<"!=b&&">="!=b&&"<="!=b)console.log("jsonFactory_createCondition(): invalid comparison parameter. Could not generate condition object.");else if(1==isNaN(c))console.log("jsonFactory_createCondition(): invalid value parameter(Not a number). Could not generate condition object.");else return{stat:a,comparison:eval,value:c}}
function conditions_createOutcome(a,b,c){if("+"!=b&&"-"!=b&&"/"!=b&&"*"!=b)console.log("jsonFactory_createOutcome(): invalid modifier parameter. Could not generate outcome object.");else if(1==isNaN(c))console.log("jsonFactory_createOutcome(): invalid value parameter(Not a number). Could not generate outcome object.");else return{stat:a,modifier:eval,value:c}};interact(".drag-element:not([locked])").draggable({inertia:!0,restrict:{restriction:"parent",endOnly:!0,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!0,onmove:dragMoveListener,onend:function(a){var b=a.target.querySelector("p");b&&(b.textContent="moved a distance of "+(Math.sqrt(a.dx*a.dx+a.dy*a.dy)|0)+"px")}});
function dragMoveListener(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx;a=(parseFloat(b.getAttribute("data-y"))||0)+a.dy;b.style.webkitTransform=b.style.transform="translate("+c+"px, "+a+"px)";b.setAttribute("data-x",c);b.setAttribute("data-y",a)}window.dragMoveListener=dragMoveListener;var playGame={};outgoingEdges=currentNode=null;function prepareForGame(){outgoingEdges=currentNode=null;$(".playpage").html("")}function parseNode(){console.log("Parse node ",currentNode.data("id"));outgoingEdges=currentNode.outgoers().edges();currentNode.hasClass("page")?parsePage(outgoingEdges):currentNode.hasClass("control")&&parseControl(outgoingEdges)}function parsePage(a){stylePage()}
function stylePage(){$(".playpage").html("");for(var a=currentNode.data("textcontainers"),b=0;b<a.length;b++)console.log("Add text container with contents: ",escapeHtml(a[b].contents)),$(".playpage").append(a[b].html),$(".playpage #text-area"+b).val(escapeHtml(a[b].contents)),$(".playpage #text-area"+b).prop("disabled","true"),$(".playpage #text-area"+b).css("resize","none");$(".playpage").children("div[id^='text-container']").each(function(a){this.setAttribute("locked","")})}
function parseControl(a){}function progressStory(a){null===currentNode?(currentNode=cy.$(".start")[0],parseNode()):0<currentNode.outgoers().size()?(currentNode=outgoingEdges.eq(a).target(),console.log("Now on node ",currentNode.data("id")),parseNode()):(currentNode=null,$(".playpage").html(""))}function stripDraggable(a){return a.replace(/drag-element/g,"")};console.log("Enter main.js version 0.5.0");var dialog=document.querySelector("dialog");dialogPolyfill.registerDialog(dialog);var testgraph={};function checkValidGraph(){var a="";cy.$(".start").hasClass("page")||(a=a.concat("Starting class must be a page node\n"));testConnectivity()||(a=a.concat("Graph is NOT connected\n"));""==a?alert("All tests passed"):alert(a)}
function testConnectivity(){var a=!1,b=cy.$("node").first(),c=cy.$("node");console.log("Root node: "+b.data("id"));var d=cy.collection(),d=d.add(b);cy.elements().dfs({roots:b,visit:function(a,b,c){d=d.add(c);console.log("visit "+this.id()+" total "+a)},directed:!0});console.log("Total nodes:"+c.size()+" Connected_nodes: "+d.size());if(c.size()==d.size())a=!0;else{var e=c.diff(d).left;console.log("Disconnected:",e.size());console.log("left: "+e.map(function(a){return a.id()}).join(", "));e.addClass("disconnected");
setTimeout(function(){e.removeClass("disconnected")},3E3)}return a};
