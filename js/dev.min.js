var initCanvas={};console.log("Enter initCanvas.js");
var cy=cytoscape({container:document.getElementById("cy"),layout:{},style:[{selector:"node",style:{label:"data(name)","text-opacity":1,"text-valign":"center","text-halign":"center","border-width":2,"border-color":"black","transition-property":"border-width, border-color","transition-duration":"0.8s"}},{selector:"edge",style:{label:"data(name)","text-background-color":"white","text-background-opacity":1,"text-border-opacity":1,"text-border-color":"#90caf9","text-border-width":2,width:4,"target-arrow-shape":"triangle",
"line-color":"#90caf9","target-arrow-color":"#90caf9","curve-style":"bezier","line-style":"solid"}},{selector:".page",style:{shape:"roundrectangle","background-color":"#aaaaaa"}},{selector:".control",style:{shape:"ellipse","background-color":"#5c6bc0"}},{selector:".source_node",style:{"border-width":7,"border-color":"#9dbaea","transition-duration":"0.1s"}},{selector:".disconnected",style:{"border-width":7,"border-color":"red","transition-property":"border-width, border-color","transition-duration":"0.1s"}},
{selector:".start",style:{label:"Start",width:40,height:40,"background-color":"#9deaa6"}},{selector:".leaf",style:{shape:"hexagon",width:35,height:35,"background-color":"#eacd9d"}},{selector:".pageedge",style:{}},{selector:".success-edge",style:{"line-color":"#a1d490","target-arrow-color":"#a1d490","text-border-color":"#a1d490"}},{selector:".fail-edge",style:{"line-color":"#c390d4","target-arrow-color":"#c390d4","text-border-color":"#c390d4"}},{selector:".parent-selected",style:{"line-style":"dashed"}},
{selector:":selected",style:{"text-border-color":"black","border-width":5,"line-color":"black","target-arrow-color":"black","transition-duration":"0.1s"}}],boxSelectionEnabled:!0,selectionType:"single",minZoom:.2,maxZoom:5});cy.panzoom();resizeCanvas();console.log("Canvas done");var states={DEFAULT:0,CONNECTING:1,NEWPAGE:2,NEWCONTROL:3};current_state=states.DEFAULT;function defaultState(){exitStates();current_state=states.DEFAULT}function exitStates(){current_state==states.CONNECTING&&(cy.boxSelectionEnabled(!0),null!==source_node&&(source_node.removeClass("source_node"),source_node=null));$("#sidebar .btn").removeClass("activebutton");$(".pagemode").html("Page Node")}
function changeState(a){exitStates();$(a).addClass("activebutton");$(a).hasClass("connectionmode")&&current_state!=states.CONNECTING?(current_state=states.CONNECTING,cy.boxSelectionEnabled(!1),source_node=null,cy.$(":selected").unselect()):$(a).hasClass("pagemode")?current_state=states.NEWPAGE:$(a).hasClass("controlmode")&&current_state!=states.NEWCONTROL?current_state=states.NEWCONTROL:($(a).hasClass("deletebutton")&&removeElement(),current_state=states.DEFAULT,$(a).removeClass("activebutton"))}
;var project={};console.log("Entering project.js");var project_project=project_createNewProject();project_updateProject();defaultState();project_updateProject();function project_createNewProject(){return{projectOwner:"none",projectName:"none",graph:[],gameAttributes:{},attributesHTML:"",resolution:{x:1E3,y:800}}}
function project_addGameAttribute(a){var b=generateID();project_project.gameAttributes[b]=new GameAttribute(null,null,a,b,!1);a='<li class="'+b+' margin">'+a+'<ul id="'+b+'-inner_list"></ul></li>';$("#attributes-list").append(a);console.log("new top level attribute added: "+project_project.gameAttributes[b].path)}
function project_updateProject(){"none"==project_project.projectOwner?(console.log("Creating new project"),project_project.projectOwner="Admin",project_project.projectName="newDemo"):console.log("Updating project...");project_project.graph=cy.elements().jsons()};var conditions={};console.log("Enter conditions.js");function conditions_createCondition(a,b,c,d){if("="!=c&&">"!=c&&"<"!=c&&">="!=c&&"<="!=c)console.log("conditions_createCondition(): invalid comparison parameter. Could not generate condition object.");else if(1==isNaN(d)||""==d)console.log("conditions_createCondition(): invalid value parameter(Not a number). Could not generate condition object.");else return{edge:a.data.id,id:getNextConditionID(a),stat:b,comparison:c,value:d}}
function conditions_createOutcome(a,b,c,d){if("+"!=c&&"-"!=c&&"/"!=c&&"*"!=c)console.log("conditions_createOutcome(): invalid modifier parameter. Could not generate outcome object.");else if(1==isNaN(d)||""==d)console.log("conditions_createOutcome(): invalid value parameter(Not a number). Could not generate outcome object.");else return{edge:a.data.id,id:getNextOutcomeID(a),stat:b,modifier:c,value:d}}
function getNextConditionID(a){for(var b=-1,c=0;c<a.data.conditions.length;c++)a.data.conditions[c].id>b&&(b=a.data.conditions[c].id);return++b}function getNextOutcomeID(a){for(var b=-1,c=0;c<a.data.outcomes.length;c++)a.data.outcomes[c].id>b&&(b=a.data.outcomes[c].id);return++b};var attributesOverlay={},attributeCount=0,attID=0;function attributesOverlay_openAttributesOverlay(){}
function attributesOverlay_addAttribute(a){var b='<li id="att-'+attID+'">  <div class="collapsible-header" id="att-'+attID+'-header">Attribute Name</div> <div class="collapsible-body"> <br/> <div class="row"> <div class="input-field col s4"> <input id="att-'+attID+'-name" type="text" class="validate"> <label for="att-'+attID+'-name">Name</label> </div> <div class="input-field col s2"> <input id="att-max-val" type="number"/> <label for="att-max-val">Max Value</label> </div> <div class="input-field col s2"> <input id="att-init-value" type="number"/> <label for="att-init-value">Initial Value</label></div>  <button class="btn btn-default" id="att-'+attID+
'" onclick="attributeOverlay_updateAttribute(this.id)">Update</button> </div> </div> </li>';$("#"+a).append(b);attributeCount++;attID++}function attributeOverlay_updateAttribute(a){var b=$("#"+a+"-name").val();$("#"+a+"-header").html(b)}function attributeOverlay_deleteAttribute(){};var events={},selected_event=null;function deleteEvent(){null!=selected_event&&$(selected_event).remove()}function eventManager(){this.page_time=0;this.playPageEvents=function(a){for(var b=0;b<a.length;b++)console.log(a[b].id,a[b].eventtype)};this.tick=setInterval(function(){this.pageTime++},1E3);this.newPage=function(){this.page_time=0}};function audioAsset(a,b,c,d){this.name="Audio "+b+": "+a;this.id=b;this.type=d;this.link=c;this.loadAndPlayAudio=function(){if("youtube"==this.type){var a=this.link.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i);audioplayer.loadVideoById(a[1],0,"large");console.log("youtube audio loaded with ID: ",a[1])}else{if("mp3"==this.type)return"Some other HTML string!";alert("You shouldn't be here...")}};this.addEvent=function(){$("#eventspane").append("<div id = '"+
this.id+"' class='audioevent eventscontainer'><span class = 'eventname flex-center-vertically'>"+this.name+"</span><span class = 'eventtype flex-center-vertically'><select><option value='Play'>Play</option><option value='Stop'>Stop</option></select></span><span class = 'eventtrigger'><input type='number' min = 0 value = 0></span></div>");$(".eventscontainer").last().on("click",".eventname",function(a){a.preventDefault();$(".eventscontainer").removeClass("highlighted");$(this).parent().toggleClass("highlighted");
selected_event=$(this).parent();console.log(selected_event)});$(".eventtype select").material_select()}}
function audioObj(){this.selected_audio=null;this.size=0;this.assets=[];this.getAssetAsModalList=function(a){var b="";if(void 0!=a)a=this.assets[a],b+="<li id='"+a.id+"''>Name: "+a.name+"<br>Link: "+a.link+"</li>";else for(var c=0;c<this.assets.length;c++)a=this.assets[c],b+="<li id='"+a.id+"''>Name: "+a.name+"<br>Link: "+a.link+"</li>";return b};this.getAssetAsMenu=function(){assetlist={};for(var a=0;a<this.assets.length;a++)console.log("Generate audio menu"),assetlist[a]={name:this.assets[a].name,
id:this.assets[a].id,callback:function(a,c){audio.assets[a].addEvent()}};return assetlist};this.getAsset=function(a){return void 0!==a?0<=a?this.assets.find(function(b){return b.id===a}):!1:this.assets};this.removeAsset=function(){if(null!=this.selected_audio){var a=this.getAsset(parseInt(this.selected_audio));this.assets.splice(this.assets.indexOf(a),1);$("#audiolist").find("#"+this.selected_audio).remove()}};this.addAssetButton=function(){var a=prompt("Enter youtube link");if(null==a)console.log("Link cannot be empty");
else{var b=prompt("Give audio a name");null==b?console.log("Name cannot be empty"):(this.addAsset(b,a),$("#audiolist li").on("click",function(a){a.preventDefault();$("#audiolist li").removeClass("highlighted");$(this).toggleClass("highlighted");audio.selected_audio=$(this).attr("id")}))}};this.addAsset=function(a,b){var c=this.parseType(b);"error"!=c?(this.assets[this.size]=new audioAsset(a,this.size,b,c),this.size++,$("#audiolist").html(""),$("#audiolist").append(this.getAssetAsModalList())):console.log("Failed to add asset")};
this.parseType=function(a){return a.match(/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/)&&RegExp.$1?"youtube":"error"};this.addAudioEvent=function(a){this.assets[a].addEvent()}}var audio=new audioObj;testAudioObjects();
function testAudioObjects(){audio.addAsset("Reggae Rap","https://www.youtube.com/watch?v=4vKmEmY8ZD8");audio.addAsset("Fantasy RPG","https://www.youtube.com/watch?v=Pq824AM9ZHQ");audio.addAsset("Missing You","https://www.youtube.com/watch?v=Ct_t92NloA8");audio.addAsset("Electronic","https://www.youtube.com/watch?v=MiRcFl8iafg");console.log(audio.getAsset(0));console.log(audio.getAsset(1));console.log(audio.getAsset());console.log(audio.getAsset("a"));console.log(audio.getAsset(-1));console.log(audio.getAsset(2))}
function onYouTubePlayerAPIReady(){audioplayer=new YT.Player("audioplayer",{height:"100",width:"100",events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange,onError:onPlayerError}})}function onPlayerReady(a){alert("started video")}function onPlayerStateChange(a){-1===a.data&&alert("youtube video not started");5===a.data&&alert("youtube video queued");1===a.data&&alert("now playing");0===a.data&&alert("done")}
function onPlayerError(a){alert("Youtube audio playback encountered error: ",a.data,". Embedding of this link may be disabled by the owner.");console.log(a.data)};var httpRequests={};console.log("Enter httpRequests.js");function http_save(){console.log("save");project_updateProject();$.ajax({type:"POST",url:"/saveProject",data:{save:JSON.stringify(project_project)},success:function(a){alert("Graph Saved")},contenttype:"application/json"})}
function http_load(){console.log("Load");var a=cy.elements();cy.remove(a);$.ajax({url:"/getProject",data:{projectOwner:"Admin",projectName:"newDemo"},cache:!1,type:"GET",success:function(a){delete a[0]._id;project_project=a[0];for(var c=0;c<a[0].graph.length;c++)if("edges"==a[0].graph[c].group)cy.add(a[0].graph[c]).on("tap",function(a){this.select()});else cy.add(a[0].graph[c])},contenttype:"application/json"})}
function http_delete(a){console.log("Delete");$.ajax({type:"POST",url:"php/delete.php",data:JSON.stringify(a),success:function(a){},contentType:"application/json"})}function http_packageProject(a,b,c){a={username:a,graph:[],statTypes:[]};a.graph=b;a.statTypes=c;return a};var generalOverlay={};$(document).ready(function(){$(".modal-trigger").leanModal({dismissible:!0,ready:function(){var a=cy.$(":selected")[0];null!=a&&(a.hasClass("page")?(openEditPageOverlay(a),console.log("Opening page overlay")):a.isEdge()?(openEditConnectionOverlay(a),console.log("Opening Edge Overlay")):a.hasClass("control")&&(openEditControlOverlay(a),console.log("Opening Control Overlay")))},complete:function(){closeOverlay(null)}})});
function openEditPageOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);null===a&&overlayToolbar(b);if(b.hasClass("page")){$("#pagename").html("Design Page: "+b.data("name"));$("#pagecontainers").append('<a style="float:right" class="pagemenu btn-floating btn waves-effect waves-light gray"><i class="material-icons">settings</i></a>');a=b.data("pagestyle");$("#pagecontainers").attr("style",a);a=b.data("outputcontainer");$("#pagecontainers").append(a);$("#pagecontainers div.output-container:last").prepend(genHandleHTML("output",
0));var c=b.data("textcontainers");for(a=0;a<c.length;a++)$("#pagecontainers").append(c[a].html),$("#pagecontainers div.text-container:last").prepend(genHandleHTML("text",c[a].name));c=b.data("imgcontainers");for(a=0;a<c.length;a++)$("#pagecontainers").append(c[a].html),$("#pagecontainers div.img-container:last").prepend(genHandleHTML("img",c[a].name));$("#eventspane").append('<span class="eventspanetitle eventname" style="text-align:center; font-size: 16px;">Asset</span><span class="eventspanetitle eventtype" style="text-align:center; font-size: 16px;">Event</span><span class="eventspanetitle eventtrigger" style="text-align:center; font-size: 16px;">Time</span>');
a=b.data("events");for(c=0;c<a.length;c++)audio.getAsset(parseInt(a[c].id))&&audio.getAsset(parseInt(a[c].id)).addEvent(),$(".eventtrigger input").last().val(a[c].trigger),$(".eventtype select").last().val(a[c].action),$("#eventspane select").last().material_select();outgoingEdges=b.outgoers().edges();for(var d=b.data("decisioncontainers"),c=0;c<outgoingEdges.size();c++){var e=!1;for(a=0;a<d.length;a++)outgoingEdges[c].data("name")==d[a].name&&(e=!0);e||addDecisionContainer(b,c,outgoingEdges.eq(c).data("text"),
outgoingEdges[c].data("name"))}for(a=0;a<d.length;a++){e=!1;for(c=0;c<outgoingEdges.size();c++)d[a].name==outgoingEdges[c].data("name")&&($("#pagecontainers").append(d[a].html),$("#pagecontainers div.decision-container:last").prepend(genHandleHTML("decision",d[a].name)),e=!0);e||d.splice(a,1)}show_handles||$(".handle").hide();bindHandleSelection()}}function openEditConnectionOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);populateEdgeOverlay(b.json())}
function openEditControlOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);$("#controlcontainers #controltext").val(escapeHtml(b.data("text")));populateControlOverlay(b)}
function openAudioOverlay(){console.log("Audio overlay opened");$("#audio-modal").openModal({dismissible:!0,ready:function(){audio.selected_audio=null;$("#audiolist").html("");$("#audiolist").append(audio.getAssetAsModalList());$("#audiolist li").on("click",function(a){a.preventDefault();$("#audiolist li").removeClass("highlighted");$(this).toggleClass("highlighted");audio.selected_audio=$(this).attr("id")})},complete:function(){}})}
function overlayToolbar(a){a.hasClass("control")?($("#controltoolbar").show(),$("#controlname").text("control "+a.data("id"))):a.hasClass("page")?($("#pagetoolbar").show(),$("#pagename").text("Page "+a.data("name"))):a.isEdge()&&($("#connectiontoolbar").show(),$("#connectionname").text("Connection "+a.data("name")))}
function closeOverlay(a){var b=a;null===a&&(b=cy.$(":selected")[0]);if(null!=b){if(b.hasClass("page")){$("#pagecontainers .handle").remove();b.data("textcontainers",[]);b.data("imgcontainers",[]);b.data("events",[]);b.data("pagestyle",$("#pagecontainers").attr("style"));b.data("outputcontainer",$(".output-container").outerHTML);var c=[];$("#pagecontainers").children("div[class^='text-container']").each(function(a){var b=this.outerHTML;console.log("Updating HTML for ",a);c.push({name:a+1,html:b})});
b.data("textcontainers",c);$("#pagecontainers").children("div[class^='decision-container']").each(function(a){var c=this.outerHTML;b.data("decisioncontainers")[a].html=c;console.log("Save HTML for decision ",a)});var d=[];$("#pagecontainers").children("div[class^='img-container']").each(function(a){var b=this.outerHTML;console.log("Save HTML for img ",a);d.push({name:a+1,html:b})});b.data("imgcontainers",d);var e=[];$("#eventspane").children(".eventscontainer").each(function(a){var b=$(this).children(".eventname"),
c=$(this).attr("class").split(" ")[0];a=b.nextAll(".eventtype:first");var d=a.nextAll(".eventtrigger:first"),h=$(this).attr("id"),b={eventtype:c,id:h,name:b.html(),action:a.find("div input").val(),trigger:d.find("input").val()};a.material_select("destroy");e.push(b)});e.sort(function(a,b){return parseFloat(a.trigger)-parseFloat(b.trigger)});b.data("events",e);b.data("eventspane",$("#eventspane").html());$("#pagecontainers").html("");$("#eventspane").html("");selected_event=null}b.hasClass("control")&&
(saveControl(b),$("#connectedEdgesList").children().remove());b.isEdge()&&(saveEdge(b,"EDGE_OVERLAY"),$("#conditionsList").children().remove(),$("#outcomesList").children().remove())}}function showOverlayLinks(a){$(".editbutton").hide();a.hasClass("page")?$('a[href="#page-modal"]').show():a.hasClass("control")?$('a[href="#control-modal"]').show():a.hasClass("pageedge")?$('a[href="#connection-modal"]').show():a.hasClass("controledge")&&$('a[href="#connection-modal"]').show()}
function escapeHtml(a){var b=document.createElement("div");b.appendChild(document.createTextNode(a));return b.innerHTML}function htmlToElements(a){var b=document.createElement("template");b.innerHTML=a;return b.content.childNodes};var edgeOverlay={},edgeOverlay_newConditionCount=0,edgeOverlay_newOutcomeCount=0,edgeOverlay_selectedEdge;function populateEdgeOverlay(a){edgeOverlay_newOutcomeCount=edgeOverlay_newConditionCount=0;edgeOverlay_selectedEdge=a;for(var b=0;b<a.data.conditions.length;b++){var c=a.data.conditions[b];console.log(c);edgeOverlay_addExistingCondition("conditionsList",c)}for(b=0;b<a.data.outcomes.length;b++)c=a.data.outcomes[b],edgeOverlay_addExistingOutcome("outcomesList",c)}
function saveEdge(a,b){for(var c=a.json(),d=0;d<c.data.conditions.length;d++){var e=c.data.conditions[d],f="exCondition_"+e.edge+"_"+e.id;0!==$("#"+f+"_statTypeList").length&&(e.stat=$("#"+f+"_statTypeList").val(),e.comparison=$("#"+f+"_compList").val(),e.value=$("#"+f+"_value").val())}for(d=0;d<c.data.outcomes.length;d++)e=c.data.outcomes[d],f="exOutcome_"+e.edge+"_"+e.id,0!==$("#"+f+"_statTypeList").length&&(e.stat=$("#"+f+"_statTypeList").val(),e.modifier=$("#"+f+"_modList").val(),e.value=$("#"+
f+"_value").val());if("EDGE_OVERLAY"===b){for(d=0;d<edgeOverlay_newConditionCount;d++){var e=$("#newCondition_statTypeList"+d).val(),g=$("#newCondition_compList"+d).val(),f=$("#newCondition_value"+d).val(),e=conditions_createCondition(c,e,g,f);console.log(e);void 0!==e&&c.data.conditions.push(e)}for(d=0;d<edgeOverlay_newOutcomeCount;d++)e=$("#newOutcome_statTypeList"+d).val(),g=$("#newOutcome_modList"+d).val(),f=$("#newOutcome_value"+d).val(),e=conditions_createOutcome(c,e,g,f),console.log(e),void 0!==
e&&c.data.outcomes.push(e)}edgeOverlay_newOutcomeCount=edgeOverlay_newConditionCount=0}function populateStatsDropDownMenu(a){a="#"+a;for(var b=0;b<project_project.statTypes.length;b++)$(a).append('<option value="'+project_project.statTypes[b].type+'">'+project_project.statTypes[b].type+"</option>"),$(a).material_select()}
function edgeOverlay_addNewCondition(a){var b='<li id="newCondition_'+edgeOverlay_newConditionCount+'"><div class="row"><div class="input-field col s2"><select id="newCondition_statTypeList'+edgeOverlay_newConditionCount+'"></select></div><div class="input-field col s2"><select id="newCondition_compList'+edgeOverlay_newConditionCount+'"><option value=">">></option><option value="<"><</option><option value=">=">>=</option><option value="<="><=</option><option value="=">=</option></select></div><div class="input-field col s2"><input placeholder="Enter Value" id="newCondition_value'+
edgeOverlay_newConditionCount+'" type="number" class="validate"></div><div class="input-field col s1 offset-s5"><a id="newCondition_delete'+edgeOverlay_newConditionCount+'" class="btn-floating btn waves-effect waves-light red" onclick=removeCondition(\'newCondition_'+edgeOverlay_newConditionCount+'\')><i class="material-icons">delete</i></a></div>';"</div></li>";$("#"+a).append(b);$("#newCondition_"+edgeOverlay_newConditionCount).hide(0,function(){$("#newCondition_"+edgeOverlay_newConditionCount).show(300)});
$("#newCondition_statTypeList"+edgeOverlay_newConditionCount).material_select();$("#newCondition_compList"+edgeOverlay_newConditionCount).material_select();populateStatsDropDownMenu("newCondition_statTypeList"+edgeOverlay_newConditionCount);edgeOverlay_newConditionCount++}
function edgeOverlay_addNewOutcome(a){var b="<li id= newOutcome_"+edgeOverlay_newOutcomeCount+'><div class="row"><div class="input-field col s2"><select id="newOutcome_statTypeList'+edgeOverlay_newOutcomeCount+'"></select></div><div class="input-field col s2"><select id="newOutcome_modList'+edgeOverlay_newOutcomeCount+'"><option value="+">+</option><option value="-">-</option><option value="*">*</option><option value="/">/</option><option value="=">=</option></select></div><div class="input-field col s2"><input placeholder="Enter Value" id="newOutcome_value'+
edgeOverlay_newOutcomeCount+'" type="number" class="validate" ></div><div class="input-field col s1 offset-s5"><a id="newOutcome_delete'+edgeOverlay_newOutcomeCount+'" class="btn-floating btn waves-effect waves-light red" onclick=removeOutcome(\'newOutcome_'+edgeOverlay_newOutcomeCount+'\')><i class="material-icons">delete</i></a></div>';"</div>";"</li>";$("#"+a).append(b);$("#newOutcome_"+edgeOverlay_newOutcomeCount).hide(0,function(){$("#newOutcome_"+edgeOverlay_newOutcomeCount).show(300)});$("#newOutcome_statTypeList"+
edgeOverlay_newOutcomeCount).material_select();$("#newOutcome_modList"+edgeOverlay_newOutcomeCount).material_select();populateStatsDropDownMenu("newOutcome_statTypeList"+edgeOverlay_newOutcomeCount);edgeOverlay_newOutcomeCount++}
function edgeOverlay_addExistingCondition(a,b){var c="exCondition_"+b.edge+"_"+b.id,d='<li id="'+c+'"><div class="row"><div class="input-field col s2"><select id="'+c+'_statTypeList"></select></div><div class="input-field col s2"><select id="'+c+'_compList"><option value=">">></option><option value="<"><</option><option value=">=">>=</option><option value="<="><=</option><option value="=">=</option></select></div><div class="input-field col s2"><input placeholder="Enter Value" id="'+c+'_value" type="number" class="validate" ></div><div class="input-field col s1 offset-s5"><a id="'+
c+'_delete" class="btn-floating btn waves-effect waves-light red" onclick=removeCondition(\''+c+'\')><i class="material-icons">delete</i></a></div></div></li>';$("#"+a).append(d);$("#"+c+"_statTypeList").material_select();$("#"+c+"_compList").material_select();populateStatsDropDownMenu(c+"_statTypeList");$("#"+c+"_statTypeList").val(b.stat);$("#"+c+"_compList").val(b.comparison);$("#"+c+"_value").val(b.value);$("#"+c+"_statTypeList").material_select();$("#"+c+"_compList").material_select();$("#"+
c).hide(0,function(){$("#"+c).show(300)})}
function edgeOverlay_addExistingOutcome(a,b){var c="exOutcome_"+b.edge+"_"+b.id,d="<li id="+c+'><div class="row"><div class="input-field col s2"><select id="'+c+'_statTypeList"></select></div><div class="input-field col s2"><select id="'+c+'_modList"><option value="+">+</option><option value="-">-</option><option value="*">*</option><option value="/">/</option><option value="=">=</option></select></div><div class="input-field col s2"><input placeholder="Enter Value" id="'+c+'_value" type="number" class="validate"></div><div class="input-field col s1 offset-s5"><a id="'+
c+'_delete" class="btn-floating btn waves-effect waves-light red" onclick=removeOutcome(\''+c+'\')><i class="material-icons">delete</i></a></div></div></li>';$("#"+a).append(d);$("#"+c+"_statTypeList").material_select();$("#"+c+"_modList").material_select();populateStatsDropDownMenu(c+"_statTypeList");$("#"+c+"_statTypeList").val(b.stat);$("#"+c+"_modList").val(b.modifier);$("#"+c+"_value").val(b.value);$("#"+c+"_statTypeList").material_select();$("#"+c+"_modList").material_select();$("#"+c).hide(0,
function(){$("#"+c).show(300)})}function removeCondition(a){$("#"+a).hide(300,function(){$("#"+a).remove()});var b=a.split("_");if("newCondition"!==b[0])if("exCondition"===b[0])for(var c=cy.edges("[id='"+b[1]+"']").json(),d=0;d<c.data.conditions.length;d++)d===parseInt(b[2])&&c.data.conditions.splice(d,1);else console.log("removeCondition(): error in id formatting")}
function removeOutcome(a){console.log("Removing outcome "+a);$("#"+a).hide(300,function(){$("#"+a).remove()});var b=a.split("_");if("newOutcome"!==b[0])if("exOutcome"===b[0])for(var c=cy.edges("[id='"+b[1]+"']").json(),d=0;d<c.data.outcomes.length;d++)d===parseInt(b[2])&&c.data.outcomes.splice(d,1);else console.log("removeOutcome(): error in id formatting")};var controlOverlay={},currentDraggedItem=resetCurentDraggedItem(),currentHoverOver=null,currentSelectedNode=null;
function populateControlOverlay(a){currentDraggedItem=resetCurentDraggedItem();currentHoverOver=null;currentSelectedNode=a;for(var b=0;b<a.json().data.priorityList.length;b++){var c=cy.edges("[id='"+a.json().data.priorityList[b]+"']").json(),d="<li id=connectedEdge_"+c.data.id+' ><div id="header_'+c.data.id+'" draggable="true" ondragend=handleDragEnd(event) ondragstart=handleDrag(event,\''+c.data.name+'\') ondragenter=handleDragEnter(event) class="collapsible-header highlight-list">Edge '+c.data.name+
'<i id="defaultIcon_'+c.data.id+'" class="small material-icons"></i></div><div class="collapsible-body"><ul id = "'+c.data.id+'_collapsible" class="collapsible" data-collapsible="expandable"><li><div class="collapsible-header">Conditions for '+c.data.name+'</div><div class="collapsible-body"><ul id = "controlConditions_'+c.data.id+'" class="list-unstyled" ></ul></div></li><li><div class="collapsible-header">Outcomes for '+c.data.name+'</div><div class="collapsible-body"><ul id = "controlOutcomes_'+
c.data.id+'" class="list-unstyled" ></ul></div></li></ul><div style="text-align: right"><button type="button" class="btn btn-default" onClick=setDefaultFailEdge(\''+c.data.id+'\') style="width: 50%;">Set As Default Fail Edge</button></div>';"</div></li>";$("#connectedEdgesList").append(d);$("#"+c.data.id+"_collapsible").collapsible({accordion:!1});for(d=0;d<c.data.conditions.length;d++)edgeOverlay_addExistingCondition("controlConditions_"+c.data.id,c.data.conditions[d]);for(d=0;d<c.data.outcomes.length;d++)edgeOverlay_addExistingOutcome("controlOutcomes_"+
c.data.id,c.data.outcomes[d])}setDefaultFailEdge(a.json().data.defaultFailEdge);activateHighlightList()}function saveControl(a){a.connectedEdges().forEach(function(a){saveEdge(a,"CONTROL_OVERLAY")});updatePriority(a)}
function updatePriority(a){console.log(a.connectedEdges().jsons());a=a.json().data.priorityList;var b=[];$("#connectedEdgesList li").each(function(a,c){var f=$(c).attr("id");void 0!==f&&(f=f.split("_"),"connectedEdge"===f[0]&&b.push(f[1]))});if(a.length===b.length)for(var c=0;c<a.length;c++)a[c]=b[c]}
function setDefaultFailEdge(a){if(null!==currentSelectedNode&&void 0!==currentSelectedNode){var b="#defaultIcon_"+currentSelectedNode.json().data.defaultFailEdge;$(b).html("");$("#defaultIcon_"+a).html("stars");cy.$("#"+currentSelectedNode.json().data.defaultFailEdge).removeClass("fail-edge");cy.$("#"+currentSelectedNode.json().data.defaultFailEdge).addClass("success-edge");currentSelectedNode.json({data:{defaultFailEdge:a}});cy.$("#"+a).removeClass("success-edge");cy.$("#"+a).addClass("fail-edge");
console.log("new default is "+a)}}
function removeEdgeFromPriorityList(a){var b=cy.nodes("[id='"+a.json().data.source+"']");if(void 0!==b){for(var c=0;c<b.json().data.priorityList.length;c++)b.json().data.priorityList[c]===a.json().data.id&&b.json().data.priorityList.splice(c,1);b.json().data.defaultFailEdge===a.json().data.id&&(0<b.json().data.priorityList.length?(b.json({data:{defaultFailEdge:b.json().data.priorityList[0]}}),setDefaultFailEdge(b.json().data.priorityList[0])):b.json({data:{defaultFailEdge:"none"}}))}}
function handleDrag(a,b){resetFromHighlight(a.target.id);a.dataTransfer.setData("Text","Dropped in zone!");currentHoverOver=a.target.id;$(".collapsible-header.active.highlight-list").each(function(a){$(this).click()});currentDraggedItem.ID=a.target.id;currentDraggedItem.parentID="connectedEdge_"+a.target.id.split("_")[1];currentDraggedItem.name=b}
function handleDragEnter(a){var b='<li id="dropZoneOuter"><div id="dropZone" class="collapsible-header" ondrop=handleDrop(event) ondragover=allowDrop(event) style="font-style: italic; background-color: gray; opacity: 0.25;"> Edge '+currentDraggedItem.name+"</div></li>";currentHoverOver!==a.target.id&&(currentHoverOver=a.target.id,"dropZone"!==currentHoverOver.split("_")[0]&&($("#dropZoneOuter").remove(),"connectedEdgesList"===currentHoverOver?(a=$("ul#connectedEdgesList li:first").attr("id").split("_")[1],
$("#connectedEdge_"+a).before(b)):$("#connectedEdge_"+currentHoverOver.split("_")[1]).after(b),$("#dropZoneOuter").hide(),$("#"+currentDraggedItem.ID).hide(0,function(){$("#dropZoneOuter").show(0)})))}
function handleDrop(a){a.preventDefault();a=$("#"+currentDraggedItem.parentID).clone();$("#"+currentDraggedItem.parentID).remove();$("#dropZoneOuter").replaceWith(a);$("#"+currentDraggedItem.parentID.split("_")[1]+"_collapsible").collapsible({accordion:!1});$("#"+currentDraggedItem.ID).show();currentHoverOver=null;activateHighlightListElement(currentDraggedItem.ID)}function handleDragEnd(a){$("#dropZoneOuter").hide(0,function(){$("#"+currentDraggedItem.ID).show(0)})}
function allowDrop(a){a.preventDefault()}function resetCurentDraggedItem(){return ret={parentID:"null",ID:"null",name:"null"}}function activateHighlightListElement(a){$("#"+a).mouseover(function(){highlightElement(this.id)}).mouseout(function(){resetFromHighlight()})}function activateHighlightList(){$(".highlight-list").mouseover(function(){highlightElement(this.id)}).mouseout(function(){resetFromHighlight()})}
function highlightElement(a){$(".highlight-list").each(function(b){b=$(this).attr("id");b===a?($("#"+b).css("box-shadow","3px 3px 15px #666"),$("#"+b).css("border-color","#C76C0C"),$("#"+b).css("background","#C76C0C"),$("#"+b).css("color","#fff"),$("#"+b).css("cursor","cursor"),$("#"+b).css("filter","alpha(opacity=100)"),$("#"+b).css("opacity","1")):($("#"+b).css("box-shadow",""),$("#"+b).css("border-color",""),$("#"+b).css("background",""),$("#"+b).css("color",""),$("#"+b).css("cursor",""),$("#"+
b).css("filter",""),$("#"+b).css("opacity",""),$("#"+b).css("filter","alpha(opacity=45)"),$("#"+b).css("opacity","0.45"),$("#"+b).css("-webkit-transition","opacity .25s ease-in-out"),$("#"+b).css("-moz-transition","opacity .25s ease-in-out"),$("#"+b).css("-ms-transition","opacity .25s ease-in-out"),$("#"+b).css("-o-transition","opacity .25s ease-in-out"),$("#"+b).css("transition","opacity .25s ease-in-out"))})}
function resetFromHighlight(a){$(".highlight-list").each(function(b){b=$(this).attr("id");b!==$(".highlight-list.active").attr("id")&&b!==a&&($("#"+b).css("box-shadow",""),$("#"+b).css("border-color",""),$("#"+b).css("background",""),$("#"+b).css("color",""),$("#"+b).css("cursor",""),$("#"+b).css("filter",""),$("#"+b).css("opacity",""),$("#"+b).css("filter",""),$("#"+b).css("-webkit-transition",""),$("#"+b).css("-moz-transition",""),$("#"+b).css("-ms-transition",""),$("#"+b).css("-o-transition",""),
$("#"+b).css("transition",""))})};var contextMenu={};function changeCSSinMenu(a,b,c,d){console.log("Inside change CSS");console.log(b);"#pagecontainers"==a?$(a).css(c,d):b.$trigger.parent().siblings(a).css(c,d)}function bringEleToFront(a){var b=0;$("#pagecontainers").children("div").each(function(){var a=$(this).css("zIndex");a>b&&(b=a)});b++;console.log("Set zIndex to ",b);a.css("zIndex",b)}var primary_colour="rgba(255,255,255,1.0)",secondary_colour="rgba(255,255,255,1.0)";
$("#ColourPicker1").spectrum({color:primary_colour,change:function(a){primary_colour=a.toRgbString();$("#ColourPicker1").css("background-color",primary_colour)}});$("#ColourPicker2").spectrum({color:secondary_colour,change:function(a){secondary_colour=a.toRgbString();$("#ColourPicker2").css("background-color",secondary_colour)}});var template_ID=0,text_template_menu_list={},decision_template_menu_list={},image_template_menu_list={},page_template_menu_list={};
$.contextMenu.types.color=function(a,b,c){console.log(a);$("<span>"+a.customName+'<ul><li class = "black"></li><li class = "gray"></li><li class = "white"></li><li class = "primary" style="background-color: '+primary_colour+';"></li><li class = "secondary" style="background-color: '+secondary_colour+';"></li>').appendTo(this).on("click","li",function(){var b=a.className.split(" ")[1];changeCSSinMenu(b,c,a.className.split(" ")[0],$(this).css("background-color"));c.$menu.trigger("contextmenu:hide")});
this.addClass("color").on("contextmenu:focus",function(a){}).on("contextmenu:blur",function(a){}).on("keydown",function(a){})};
function generateContextMenu(a,b){if("text"==a||"output"==a)var c=".editdiv";else"decision"==a?c=".editdec":"img"==a?c=".editdiv":"page"==a&&(c="#pagecontainers");if("text"==a||"decision"==a||"output"==a)return{items:{font:{name:"Font",items:{Alignment:{name:"Alignment",type:"select",options:{left:"left",right:"right",Center:"Center",Justify:"Justify"}},fontfamily:{name:"Style",type:"select",options:{'"Courier New", Courier, monospace':"Courier New",'"Lucida Console", Monaco, monospace':"Lucinda",
'"Times New Roman", Times, serif':"Times New Roman",'"Arial", Helvetica, sans-serif':"Arial","Tahoma, Geneva, sans-serif":"Tahoma",'"Comic Sans MS", cursive, sans-serif':"Comic Sans"}},"font-size":{name:"Size",callback:function(a,b){var f=prompt("Enter font size","14");return 50>=f&&0<=f?changeCSSinMenu(c,b,"font-size",f+"px"):!1}},"font-color":{type:"color",customName:"Font Colour",className:"color "+c}}},background:{name:"Background",items:{Colour:{type:"color",customName:"Background Colour",className:"background-color "+
c},Opacity:{name:"Opacity",callback:function(a,b){var f=prompt("Enter an opacity from 0-100","100");if(100>=f&&0<=f){var f=f/100,g=b.$trigger.parent().siblings(c).css("background-color"),g=-1==g.indexOf("a")?g.replace(")",", "+f+")").replace("rgb","rgba"):g.substr(0,g.lastIndexOf(",")).concat(", "+f+")");console.log("Current colour: ",g);b.$trigger.parent().siblings(c).css("background-color",g)}return!1}}}},border:border_menu_entry(c),position:zIndex_menu_entry(),sep2:"---------",clone:{name:"Clone",
callback:function(a,b){}},template:{name:"Templates",items:{save:{name:"Save As",callback:function(a,e){for(var f=0;void 0!==b["template"+template_ID]&&100>f;)template_ID++,f++,console.log("conflict with template IDs");100>f&&(f=prompt("Enter name for template"),b["template"+template_ID]={name:f,savedhtml:e.$trigger.parent().parent().children(c)[0].outerHTML,callback:function(a,d){if("Load"==d.$selected.parent().siblings("span").html()){console.log("Loading: "+a);var e=d.$trigger.parent().parent().children(c),
f=e.html();e[0].outerHTML=b[a].savedhtml;d.$trigger.parent().parent().children(c).html(f)}else"Delete"==d.$selected.parent().siblings("span").html()&&delete b[a]}},template_ID++)}},load:{name:"Load",items:b},"delete":{name:"Delete",items:b}}},"delete":{name:"Delete",icon:"delete",callback:function(b,c){if(confirm("Are you sure you want to delete this container?")){var f=c.$trigger.parent().attr("id").split(a)[1];removeContainer(a,f)}}}},events:{show:function(a){$.contextMenu.setInputValues(a,this.data())},
hide:function(a){$.contextMenu.getInputValues(a,this.data());changeCSSinMenu(c,a,"border-style",this.data().Style);changeCSSinMenu(c,a,"text-align",this.data().Alignment);changeCSSinMenu(c,a,"font-family",this.data().fontfamily)}}};if("img"==a)return{items:{border:border_menu_entry(c),position:zIndex_menu_entry(),sep3:"---------",URL:{name:"Change URL",callback:function(a,b){var f=prompt("Enter new URL for image/video","http://");(html_string=checkImageURL(f,""))&&$.ajax({url:f,success:function(a){a=
$(c).parent();$(c).remove();a.append(html_string)},error:function(a){alert("URL: "+f+" does not exist")}})}},"delete":{name:"Delete",icon:"delete",callback:function(b,c){if(confirm("Are you sure you want to delete this container?")){var f=c.$trigger.parent().attr("id").split(a)[1];removeContainer(a,f)}}}},events:{show:function(a){$.contextMenu.setInputValues(a,this.data())},hide:function(a){$.contextMenu.getInputValues(a,this.data());changeCSSinMenu(c,a,"border-style",this.data().Style)}}};if("page"==
a)return{items:{border:border_menu_entry(c),background:{type:"color",customName:"Background Colour",className:"background-color "+c},resolution:{name:"Resolution",type:"select",options:{a320pxa480px:"Mobile 320x480",a800pxa600px:"Small 800x600",a1024pxa768px:"Medium 1024x768",a1280pxa1024px:"Large 1280x1024"}}},events:{show:function(a){$.contextMenu.setInputValues(a,this.data())},hide:function(a){$.contextMenu.getInputValues(a,this.data());console.log(this.data());$(c).css("border-style",this.data().Style);
null!=this.data().resolution&&($(c).css("flex","0 0 "+this.data().resolution.split("a")[1]),$(c).css("height",this.data().resolution.split("a")[2]))}}}}
function zIndex_menu_entry(){return{name:"Position",items:{Front:{name:"Bring to Front",callback:function(a,b){var c=0;$("#pagecontainers").children("div").each(function(){var a=$(this).css("zIndex");a>c&&(c=a)});c++;console.log("Set zIndex to ",c);b.$trigger.parent().parent().css("zIndex",c)}},Back:{name:"Send to Back",callback:function(a,b){var c=1E4;$("#pagecontainers").children("div").each(function(){var a=$(this).css("zIndex");a<c&&(c=a)});c--;0>c&&(c=0);console.log("Set zIndex to ",c);b.$trigger.parent().parent().css("zIndex",
c)}}}}}
function border_menu_entry(a){return{name:"Border",items:{Style:{name:"Style",type:"select",options:{none:"None",solid:"Solid","double":"Double",dashed:"Dashed",dotted:"Dotted",outset:"Outset",ridge:"Ridge"}},Colour:{type:"color",customName:"Colour",className:"border-color "+a},Corners:{name:"Rounded Corners",callback:function(b,c){var d=prompt("Enter a number from 0 (square)  to 12 (fully rounded)","5");return 12>=d&&0<=d?changeCSSinMenu(a,c,"border-radius",d+"px"):!1}},Thickness:{name:"Border Width",callback:function(b,
c){var d=prompt("Enter a number from 0 up","2");return 100>=d&&0<=d?changeCSSinMenu(a,c,"border-width",d+"px"):!1}}}}}
$(function(){$.contextMenu({selector:".textmenu",trigger:"left",build:function(a,b){return generateContextMenu("text",text_template_menu_list)}});$.contextMenu({selector:".decmenu",trigger:"left",build:function(a,b){return generateContextMenu("decision",decision_template_menu_list)}});$.contextMenu({selector:".controlmenu",trigger:"left",build:function(a,b){return generateContextMenu("output",text_template_menu_list)}});$.contextMenu({selector:".imgmenu",trigger:"left",build:function(a,b){return generateContextMenu("img",
image_template_menu_list)}});$.contextMenu({selector:".pagemenu",trigger:"left",build:function(a,b){return generateContextMenu("page")}});$.contextMenu({selector:"#addevent",trigger:"left",build:function(a,b){return{items:{Audio:{name:"Audio",items:audio.getAssetAsMenu()}}}}})});var dragDrop={};grid_snapping_mode=!1;var grid_targets=interact.createSnapGrid({x:10,y:10,range:10,offset:{x:-2,y:2}});function initSnapOptions(){return grid_snapping_mode?{targets:[grid_targets],relativePoints:[{x:1,y:1}],endOnly:!1}:{targets:[],relativePoints:[{x:1,y:1}],endOnly:!1}}var snap_options=initSnapOptions();
function setInteractions(){interact(".drag-element:not([locked])").draggable({snap:snap_options,inertia:!1,restrict:{restriction:"parent",endOnly:!1,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!0,onmove:dragMoveListener,onend:function(a){console.log(a)}}).allowFrom(".handle");interact(".resize-element").resizable({snap:snap_options,edges:{left:!0,right:!0,bottom:!0,top:!1},onmove:resizeMoveListener})}setInteractions();
function toggleGridMode(){(grid_snapping_mode=!grid_snapping_mode)?$(".gridmode").html("Grid: Enabled"):$(".gridmode").html("Grid: Disabled");$(".gridmode").toggleClass("activebutton");snap_options=initSnapOptions();setInteractions()}
function resizeMoveListener(a){var b=a.target;b.style.width=checkBounds(b.parentNode.getAttribute("data-x"),a.rect.width,$("#pagecontainers").width())+"px";b.style.height=checkBounds(b.parentNode.getAttribute("data-y"),a.rect.height,$("#pagecontainers").height())+"px"}function checkBounds(a,b,c){a=parseFloat(a)||0;console.log("Check "+a+" + "+b);a+b>c&&(b=c-a);return b}
function dragMoveListener(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx;a=(parseFloat(b.getAttribute("data-y"))||0)+a.dy;b.style.webkitTransform=b.style.transform="translate("+c+"px, "+a+"px)";b.setAttribute("data-x",c);b.setAttribute("data-y",a)}window.dragMoveListener=dragMoveListener;function modalBounds(){}var doit;window.onresize=function(){clearTimeout(doit);doit=setTimeout(modalBounds,300)};var pageOverlay={},show_handles=!0;function updatePageStyle(a){openEditPageOverlay(a);closeOverlay(a)}function toggleHandles(){show_handles=!show_handles;$(".handlemode").toggleClass("activebutton");show_handles?($(".handle").show(),$(".handlemode").html("Handles: Shown")):($(".handle").hide(),$(".handlemode").html("Handles: Hidden"))}
function addDecisionContainer(a,b,c,d){b=genPageCenterHTML(300,220,a.data("decisioncontainers").length);b="<div class = 'decision-container drag-element' style='position:absolute; z-index: "+bringContainerToFront("decision")+"; "+b+"'>";b+="<div class = 'editdec decisionbutton drag-element resize-element' contenteditable=true>"+escapeHtml(c)+"</div>";b+="</div>";c=a.data("decisioncontainers");c.push({name:d,html:b});a.data("decisioncontainers",c)}
function addOutputContainer(){if($("#pagecontainers div.output-container:last").length)alert("You may only have one control output container per page");else{var a="<div class='output-container drag-element' style='position:absolute; "+genPageCenterHTML(300,220)+"'>",a=a+"<div class='editdiv resize-element' contenteditable=false ></div></div>",a=htmlToElements(a);$("#pagecontainers").append(a);$("#pagecontainers div.output-container:last").prepend(genHandleHTML("output",0));bringContainerToFront($("pagecontainers div.output-container:last"));
show_handles||$(".handle").hide();bindHandleSelection()}}
function addTextContainer(){var a="<div class='text-container drag-element' style='position:absolute; "+genPageCenterHTML(300,220)+"'>",a=a+"<div class='editdiv resize-element' contenteditable=true ></div></div>",b=$(".text-container").length,a=htmlToElements(a);$("#pagecontainers").append(a);$("#pagecontainers div.text-container:last").prepend(genHandleHTML("text",b+1));bringContainerToFront($("pagecontainers div.text-container:last"));$("#pagecontainers div.text-container:last .editdiv").trigger("focus");show_handles||
$(".handle").hide();bindHandleSelection()}
function addImageContainer(){var a,b=prompt("Enter image url","http://i.imgur.com/6aSJo9b.gifv"),c=genPageCenterHTML(300,220);null!=b&&(a="<div class='img-container drag-element' style='position:absolute; "+c+"'>",a=checkImageURL(b,a),a+="</div>",$.ajax({url:b,success:function(b){b=$(".img-container").length;var c=htmlToElements(a);$("#pagecontainers").append(c);$("#pagecontainers div.img-container:last").prepend(genHandleHTML("img",b+1));bringContainerToFront($("pagecontainers div.img-container:last"));show_handles||
$(".handle").hide();bindHandleSelection()},error:function(a){alert("URL: "+b+" does not exist")}}))}
function checkImageURL(a,b){if(""==a)return alert("Not a valid url"),!1;if(null!=a.match(/\.(jpeg|jpg|gif|png)$/))b+="<img class='editdiv resize-element' src="+a+"></img>";else if(null!=a.match(/\.(webm)$/))b=b+"<video preload='auto' autoplay='autoplay' loop='loop' class='editdiv resize-element'>"+('<source src= "'+a+"\"type='video/webm'></source>"),b+="</video>";else if(null!=a.match(/\.(gifv|mp4)$/)){var c=a.lastIndexOf(".gifv");-1!=c&&(a=a.substr(0,c)+".mp4",console.log("Regexed to: ",a));b+="<video preload='auto' autoplay='autoplay' loop='loop' class='editdiv resize-element'>";
b+='<source src= "'+a+"\"type='video/mp4'></source>";b+="</video>"}else return alert("Not a valid url (must be a jpeg|jpg|gif|png|webm|gifv|mp4)."),!1;return b}
function genHandleHTML(a,b){var c;if("img"==a)c="<div id = 'img"+b+'\'class = \'handle img-handle\'>Image<a style="float:left" class="btn-floating btn waves-effect waves-light green"><i class="fa fa-picture-o"></i></a>',c+='<a style="float:right" class="imgmenu btn-floating btn waves-effect waves-light red"><i class="material-icons">settings</i></a>';else if("text"==a)c="<div id = 'text"+b+'\'class = \'handle text-handle\'>Text<a style="float:left" class="btn-floating btn waves-effect waves-light grey"><i class="material-icons">comment</i></a>',
c+='<a style="float:right" class="textmenu btn-floating btn waves-effect waves-light red"><i class="material-icons">settings</i></a>',c+="</div>";else if("decision"==a)c="<div id = 'decision"+b+"'class = 'handle link-handle'>Decision"+('<a style="float:left" class="btn-floating btn waves-effect waves-light blue lighten-3">'+b+"</a>"),c+='<a style="float:right" class="decmenu btn-floating btn waves-effect waves-light red"><i class="material-icons">settings</i></a>',c+="</div>";else if("output"==a)c=
"<div id = 'output"+b+'\'class = \'handle control-handle\'>Output<a style="float:left" class="btn-floating btn waves-effect waves-light indigo lighten-1"><i class="fa fa-terminal"></i></a>',c+='<a style="float:right" class="controlmenu btn-floating btn waves-effect waves-light red"><i class="material-icons">settings</i></a>',c+="</div>";else return console.log("Unknown container type when generating handle for HTML"),null;return c}
function genPageCenterHTML(a,b,c){project_project.resolution.x;project_project.resolution.y}
function removeContainer(a,b){if("decision"==a){var c=cy.$(":selected")[0];closeOverlay(c);console.log("Removing link ",b," from cytoscape");outgoingEdges=c.outgoers().edges();for(var d=0,e=!1;d<outgoingEdges.size()&&!e;)console.log("Increment to ",d),outgoingEdges[d].data("name")==b&&(console.log("Removing link ",b," from cytoscape"),e=!0,cleanup_edge_labels(outgoingEdges[d])),d++;openEditPageOverlay(c)}else $("#"+a+b).parent().remove()}
function bindHandleSelection(){$(".handle").on("mousedown",function(a){$(this).siblings().trigger("focus");bringContainerToFront($(this).parent());console.log("trigger handle")})}function bringContainerToFront(a){var b=50;$("#pagecontainers").children("div").each(function(){var a=$(this).css("zIndex");a>b&&(b=a)});b++;if("decision"==a)return b;console.log("Set zIndex to ",b);a.css("zIndex",b)};var layouts={},cose_layout={name:"cose",ready:function(){},stop:function(){},animate:!0,animationThreshold:250,refresh:1,fit:!0,padding:30,boundingBox:void 0,componentSpacing:100,nodeRepulsion:function(a){return 4E5},nodeOverlap:10,idealEdgeLength:function(a){return 10},edgeElasticity:function(a){return 100},nestingFactor:5,gravity:80,numIter:1E3,initialTemp:200,coolingFactor:.95,minTemp:1,useMultitasking:!0},concentric_layout={name:"concentric",fit:!0,padding:30,startAngle:1.5*Math.PI,sweep:void 0,
clockwise:!0,equidistant:!0,minNodeSpacing:30,boundingBox:void 0,avoidOverlap:!0,height:void 0,width:void 0,concentric:function(a){return a.degree()},levelWidth:function(a){return a.maxDegree()/4},animate:!0,animationDuration:500,animationEasing:void 0,ready:void 0,stop:void 0},grid_layout={name:"grid",fit:!0,padding:30,boundingBox:void 0,avoidOverlap:!0,avoidOverlapPadding:10,condense:!1,rows:void 0,cols:void 0,position:function(a){},sort:void 0,animate:!0,animationDuration:500,animationEasing:void 0,
ready:void 0,stop:void 0},breadth_first_layout={name:"breadthfirst",fit:!0,directed:!0,padding:30,circle:!1,spacingFactor:1.75,boundingBox:void 0,avoidOverlap:!0,roots:!1,maximalAdjustments:0,animate:!0,animationDuration:500,animationEasing:void 0,ready:void 0,stop:void 0};function style_end_nodes(){cy.elements(".leaf").removeClass("leaf");cy.$("node").successors().leaves(".page").addClass("leaf")}
function cleanup_node_labels(a){a.hasClass("start")?(cy.remove(a),cy.$(".page").first().addClass("start")):cy.remove(a);a=1;for(a;a<cy.nodes().size();a++)cy.nodes()[a].style("label",a+1),cy.nodes()[a].data("name",a+1)}
function cleanup_edge_labels(a){var b=a.source();if(b.hasClass("page"))for(var c=0;c<b.data("decisioncontainers").length;c++)if(b.data("decisioncontainers")[c].name==a.data("name")){b.data("decisioncontainers").splice(c,1);break}cy.remove(a);c=0;a=b.edgesTo("*");updatePageStyle(b);for(c;c<a.size();c++){var d=String.fromCharCode("A".charCodeAt()+c);a[c].style("label",d);a[c].data("name",d);b.hasClass("page")&&(b.data("decisioncontainers")[c].name=d)}}
function layout_driver(a){if("none"!=a){var b=null;"Tree"==a?b=breadth_first_layout:"Grid"==a?b=grid_layout:"Circle"==a?b=concentric_layout:"Spread"==a&&(b=cose_layout);null!==b?change_layout(b):console.log("No layout selected")}}function change_layout(a){"breadthfirst"==a.name&&(console.log("Set root"),a.roots=cy.$(".start"));cy.layout(a)};var ui={};function removeElement(){element=cy.$(":selected");element.empty()||(element.isNode()&&(0<element.connectedEdges().size()&&element.connectedEdges().forEach(function(a){a.hasClass("controledge")&&removeEdgeFromPriorityList(a)}),cleanup_node_labels(element)),element.isEdge()&&(element.hasClass("controledge")&&removeEdgeFromPriorityList(element),cleanup_edge_labels(element),style_end_nodes()));$(".editbutton").hide();$(".selectionbutton").hide()}
function createConnection(a){if(current_state==states.CONNECTING&&a.isNode())if(null==source_node)source_node=a,source_node.addClass("source_node"),console.log("Source node assigned as node",source_node.data("id"));else if(source_node.data("id")!=a.data("id")){console.log("Creating link from ",source_node.data("id")," to ",a.data("id"));var b="";if(source_node.hasClass("control")){var c=source_node.edgesTo("*"),b="fail-edge";c.forEach(function(a){a.hasClass("fail-edge")&&(b="success-edge")});b+=" controledge"}else source_node.hasClass("page")&&
(b+="pageedge");c=String.fromCharCode("A".charCodeAt()+source_node.edgesTo("*").size());a=cy.add({data:{name:c,source:source_node.data("id"),target:a.data("id"),text:"<Decision text to display)>",conditions:[],outcomes:[]},classes:b,group:"edges"});a.on("tap",function(a){this.select()});source_node.hasClass("control")&&(source_node.json().data.priorityList.push(a.json().data.id),console.log("control nodes defaultFailEdge: "+source_node.json().data.defaultFailEdge),"none"===source_node.json().data.defaultFailEdge&&
(console.log("setting initial default fail edge to "+a.json().data.id),source_node.json({data:{defaultFailEdge:a.json().data.id}}),console.log("default fail edge is "+source_node.json().data.defaultFailEdge)));console.log(cy.elements().jsons());source_node.removeClass("source_node");source_node=null;style_end_nodes()}}
function resizeCanvas(){var a=$(window).width(),b=$(window).height(),c=$("#tabheadings").height()+$(".nav-wrapper").height();$("#cy").css("width",9*a/12-30);$("#cy").css("height",b-c);$("#sidebar").css("height",b-c);console.log("We resized, width: "+a+" height: "+b);cy.resize()}$(window).resize(resizeCanvas);
var observer=new MutationObserver(function(a){a.forEach(function(a){(a.oldvalue="block"==a.target.style.display)&&cy.resize()})}),cytabNode=$("#cyTab")[0],observerConfig={attributes:!0,childList:!1,characterData:!1,attributeOldValue:!0,attributeFilter:["style"]};observer.observe(cytabNode,observerConfig);var pageTemplates={},page_templates={Default:{pagestyle:"width:800px; height:600px; \tborder: 3px solid #BBBBBB",outputcontainer:"",imgcontainers:[],audio:"none",textcontainers:[],decisioncontainers:[]}},selected_page_template=page_templates.Default;
function createPageTemplate(){var a=prompt("Enter name for page template");if("Default"===a)alert("Can't override Default");else{var b=cy.$(":selected")[0].data();page_templates[a]=b;$("#pagetemplates").append("<li><a onclick=\"chooseNodeTemplate('"+a+"');\">"+a+"</a></li>")}}function chooseNodeTemplate(a){selected_page_template=page_templates[a];$(".pagemode").html("Page Node ("+a+")");console.log("Select template: "+a)};var canvasEvents={};console.log("Enter canvasEvents.js");source_node=null;cy.on("tap",":selected",function(a){console.log("Tapped on: ",cy.$(":selected").data("name"));current_state===states.CONNECTING&&createConnection(a.cyTarget)});
cy.on("tap",function(a){var b=a.cyTarget;b===cy&&cy.$(":selected").unselect();current_state===states.CONNECTING&&b===cy&&null!==source_node&&(source_node.removeClass("source_node"),source_node=null);current_state===states.NEWPAGE?(console.log("Add a node"),b===cy&&console.log("Really Add a node"+cy.add({data:{name:cy.nodes().size()+1,pagestyle:selected_page_template.pagestyle,outputcontainer:selected_page_template.outputcontainer,imgcontainers:selected_page_template.imgcontainers,audio:selected_page_template.audio,
textcontainers:selected_page_template.textcontainers,decisioncontainers:[],events:[],eventspane:'<div class= "eventscontainer"><span class="eventspanetitle eventname" style="text-align:center; font-size: 16px;">Asset</span><span class="eventspanetitle eventtype" style="text-align:center; font-size: 16px;">Event</span><span class="eventspanetitle eventtrigger" style="text-align:center; font-size: 16px;">Trigger</span></div>'},classes:"page",group:"nodes",renderedPosition:a.cyRenderedPosition}).data()),
1===cy.elements(".page").size()&&cy.$(".page").first().addClass("start")):current_state===states.NEWCONTROL&&b===cy&&cy.add({data:{name:cy.nodes().size()+1,text:"control node text",priorityList:[],defaultFailEdge:"none"},classes:"control",group:"nodes",renderedPosition:a.cyRenderedPosition})});
cy.on("select",function(a){a.cyTarget.isNode()&&a.cyTarget.outgoers().addClass("parent-selected");console.log("Select event fired ",a.cyTarget.data("id"));current_state===states.CONNECTING&&(a.cyTarget.isEdge()&&(defaultState(),showOverlayLinks(a.cyTarget)),cy.$(":selected").diff(a.cyTarget).left.unselect(),createConnection(a.cyTarget));showOverlayLinks(a.cyTarget);$(".selectionbutton").show()});
cy.on("unselect",function(a){a.cyTarget.isNode()&&a.cyTarget.outgoers().removeClass("parent-selected");console.log("Unselect event fired ",a.cyTarget.data("id"));0===cy.$(":selected").size()?($(".editbutton").hide(),$(".selectionbutton").hide()):showOverlayLinks(cy.$(":selected")[0])});var gameAttributes={};function GameAttribute(a,b,c,d,e,f){this.name=c;this.is_leaf=e;this.value=f;null!=a?(this.level=b+1,this.path=a+"_"+d):(this.path=d,this.level=0);this.children=[]}function gameAttributes_addAttributeValue(a,b,c){gameAttributes_addChild(a,b,!0,c)}function gameAttributes_addAttributeClass(a,b){gameAttributes_addChild(a,b,!1)}
function gameAttributes_addChild(a,b,c,d){console.log("New Child: "+b);a=gameAttributes_find(a);var e=generateID();a[e]=new GameAttribute(a.path,a.level,b,e,c,d);d=a[e];a.children.push(e);console.log("New Nested attribute added under: "+a.path);console.log("New Attribute ID: "+e);var f="'"+d.path+"'";b=c?'<li class="'+e+' margin"><a onclick="gameAttributes_display('+f+')">'+b+"</a></li>":'<li class="'+e+' margin"><a onclick="gameAttributes_display('+f+')">'+b+'</a><ul id="'+d.path+'-inner_list"></ul></li>';
$("#"+a.path+"-inner_list").append(b)}function gameAttributes_find(a){path=a.split("_");a=project_project.gameAttributes;for(var b=0;b<path.length;b++)a=a[path[b]];return a}function gameAttributes_update(a,b,c){a=gameAttributes_find(a);a.name=b;a.value=c;console.log(a+" Updated")}
function gameAttributes_delete(a){path=a.split("_");a=project_project.gameAttributes;for(var b=0;b<path.length-1;b++)a=a[path[b]];console.log(a);console.log("Deleting - "+path[path.length-1]);a[path[path.length-1]]=null;delete a[path[path.length-1]]}
function gameAttributes_display(a){a=gameAttributes_find(a);console.log("displaying attribute in panel: "+a.name);var b=$("#attribute-detail-title"),c=$("#attribute-detail-class-list"),d=$("#values-chips-container"),e=$("#add-class-name"),f=$("#add-value-name"),g=$("#add-value-data");c.empty();d.empty();b.text(" ");b.text(a.name);if(a.is_leaf)$("#attribute-detail").show();else for($("#attribute-detail").show(),e.attr("data-path",a.path),g.attr("data-path",a.path),f.attr("data-path",a.path),e=a.children,
b=0;b<e.length;b++)a[e[b]].is_leaf?d.append('<div class="chip" onclick="gameAttributes_display(\''+a[e[b]].path+"')\">"+a[e[b]].name+": "+a[e[b]].value+"</div>"):c.append('<div class="chip" onclick="gameAttributes_display(\''+a[e[b]].path+"')\">"+a[e[b]].name+"</div>")}function generateID(){for(var a="",b=0;4>b;b++)a+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return a}
function saveListHTML(){project_project.attributeHTML=$("#attributes-list").html()}function loadListHTML(){$("#attributes-list").html(project_project.attributeHTML)}function showAddValueInput(){$("#new-value-button").parent().hide();$("#new-value-container").show()}function showAddClassInput(){$("#new-class-button").parent().hide();$("#new-class-container").show()}
$("#add-class-name").keypress(function(a){13==a.which&&(console.log("enter clicked"),a=$("#add-class-name"),gameAttributes_addAttributeClass(a.attr("data-path"),a.val()),a.val(""),gameAttributes_display(a.attr("data-path")),$("#new-class-button").parent().show(),$("#new-class-container").hide())});
$(".add-value").keypress(function(a){if(13==a.which){a=$("#add-value-name");var b=$("#add-value-data");gameAttributes_addAttributeValue(a.attr("data-path"),a.val(),b.val());b.val("");a.val("");gameAttributes_display(a.attr("data-path"));$("#new-value-button").parent().show();$("#new-value-container").hide()}});var hotkeys={},nodes_to_clone;
$(document).ready(function(){var a=!1;$("html").on("keyup",function(b){if(17==b.which||91==b.which)a=!1}).on("keydown",function(b){if(17==b.which||91==b.which)a=!0;if(!$(".modal").hasClass("open"))if(console.log(b.which),a&&67==b.which)0!=cy.$(":selected").length&&(console.log("Copy"),nodes_to_clone=cy.$(":selected").nodes().jsons(),console.log(nodes_to_clone));else if(a&&86==b.which){if(console.log(nodes_to_clone),null!==nodes_to_clone){console.log("Paste");cy.$(":selected").unselect();for(b=0;b<
nodes_to_clone.length;b++){var c={x:nodes_to_clone[b].position.x+10,y:nodes_to_clone[b].position.y+=10};nodes_to_clone[b].data.name=parseInt(cy.nodes().size()+1);nodes_to_clone[b].classes=nodes_to_clone[b].classes.replace("start","");delete nodes_to_clone[b].data.id;cy.add({data:nodes_to_clone[b].data,classes:nodes_to_clone[b].classes,group:nodes_to_clone[b].group,position:c}).select()}nodes_to_clone=cy.$(":selected").nodes().jsons()}}else 27==b.which?(console.log("Press escape!"),$(".modal").hasClass("open")||
(defaultState(),cy.$(":selected").unselect())):49<=b.which&&58>=b.which?"none"==$("#pagetemplates").css("display")?49==b.which?$(".pagemode").trigger("click"):50==b.which?$(".controlmode").trigger("click"):51==b.which&&$(".connectionmode").trigger("click"):$("#pagetemplates li a").eq(b.which-49).trigger("click"):0!=cy.$(":selected").length&&(8==b.which||46==b.which?(console.log("Press delete"),$(".deletebutton")[0].click()):13!=b.which&&32!=b.which||$(".editbutton").each(function(a){"none"!=$(this).css("display")&&
(console.log("Enter press on ",$(this)),$(this).trigger("click"))}))})});var playGame={};outgoingEdges=currentNode=null;event_manager=new eventManager;function prepareForGame(){event_manager.tick;outgoingEdges=currentNode=null;$(".playpage").html("");for(var a=cy.elements(),b=0;b<a.length;b++)updatePageStyle(a[b])}function wipeGame(){audioplayer.stopVideo();$(".playpage").html("");$(".playpage").attr("style","")}
function parseNode(){console.log("Parse node ",currentNode.data("id"));outgoingEdges=currentNode.outgoers().edges();currentNode.hasClass("page")?parsePage(outgoingEdges):currentNode.hasClass("control")&&parseControl(currentNode,outgoingEdges)}function parsePage(a){event_manager.newPage();event_manager.playPageEvents(currentNode.data("events"));stylePage()}
function stylePage(){$(".playpage").html("");$(".playpage").attr("style",currentNode.data("pagestyle"));for(var a=currentNode.data("textcontainers"),b=currentNode.data("decisioncontainers"),c=currentNode.data("imgcontainers"),d=currentNode.data("outputcontainer"),e=currentNode.data("events"),f=0;f<a.length;f++)$(".playpage").append(a[f].html);for(f=0;f<c.length;f++)$(".playpage").append(c[f].html);for(f=0;f<b.length;f++)$(".playpage").append(b[f].html);$(".playpage").append(d);$(".playpage").children("div[class^='decision-container']").each(function(a){$(this).click(function(){progressStory(a)})});
$(".playpage .handle").hide();$(".playpage").children().removeClass("resize-element");$(".playpage").children().children().removeClass("resize-element");$(".playpage").children().attr("contenteditable","false");$(".playpage").children().children().attr("contenteditable","false");for(f=0;f<e.length;f++);}function parseControl(a,b){progressStory(0)}function getIndexFromOutgoingEdges(a,b){for(var c=b.jsons(),d=0;d<c.length;d++)if(c[d].data.id===a)return d;return-1}
function assessEdge(a){a=cy.edges("[id='"+a+"']");console.log("Assessing edge "+a.json().data.name);if(void 0!==a){var b=a.json().data.conditions;a=[];for(var c=project_project.characters[0],d=0;d<b.length;d++){var e=b[d];switch(e.comparison){case "=":parseInt(c[e.stat])===parseInt(e.value)?a[d]=!0:a[d]=!1;break;case "!=":parseInt(c[e.stat])!==parseInt(e.value)?a[d]=!0:a[d]=!1;break;case ">":parseInt(c[e.stat])>parseInt(e.value)?a[d]=!0:a[d]=!1;break;case "<":parseInt(c[e.stat])<parseInt(e.value)?
a[d]=!0:a[d]=!1;break;case ">=":parseInt(c[e.stat])>=parseInt(e.value)?a[d]=!0:a[d]=!1;break;case "<=":parseInt(c[e.stat])<=parseInt(e.value)?a[d]=!0:a[d]=!1}!0===a[d]?console.log("Condition '"+e.stat+" "+e.comparison+" "+e.value+"' is true"):console.log("Condition '"+e.stat+" "+e.comparison+" "+e.value+"' is false")}b=!0;for(c=0;c<a.length;c++)!1===a[c]&&(b=!1);0===b.length&&(b=!1);return b}console.log("assessEdge(): invalid edge. unable to assess");return!1}
function executeOutcomes(a){console.log("Executing outcomes");console.log(project_project.characters[0]);outcomes=a.json().data.outcomes;a=project_project.characters[0];for(var b=0;b<outcomes.length;b++){var c=outcomes[b];switch(c.modifier){case "=":a[c.stat]=parseInt(c.value);break;case "+":a[c.stat]=parseInt(a[c.stat])+parseInt(c.value);break;case "-":a[c.stat]=parseInt(a[c.stat])-parseInt(c.value);break;case "*":a[c.stat]=parseInt(a[c.stat])*parseInt(c.value);break;case "/":a[c.stat]=parseInt(a[c.stat])/
parseInt(c.value)}}console.log(project_project.characters[0])}function progressStory(a){null===currentNode?1>cy.$("*").length?alert("Your graph is empty"):(currentNode=cy.$(".start")[0],parseNode()):0<currentNode.outgoers().size()?(currentNode=outgoingEdges.eq(a).target(),console.log("Now on node ",currentNode.data("id")),parseNode()):(currentNode=null,$(".playpage").html(""))}function stripDraggable(a){return a.replace(/drag-element/g,"")};console.log("Enter main.js version 0.5.0");$("select").material_select();$(".tooltip").tooltip();var testgraph={};function checkValidGraph(){var a="";1>cy.$("*").length&&(a=a.concat("The graph is empty\n"));cy.$(".start").hasClass("page")||(a=a.concat("Starting class must be a page node\n"));testConnectivity()||(a=a.concat("Graph is NOT connected\n"));""==a?alert("All tests passed"):alert(a)}
function testConnectivity(){var a=!1,b=cy.$("node").first(),c=cy.$("node");console.log("Root node: "+b.data("id"));var d=cy.collection(),d=d.add(b);cy.elements().dfs({roots:b,visit:function(a,b,c){d=d.add(c);console.log("visit "+this.id()+" total "+a)},directed:!0});console.log("Total nodes:"+c.size()+" Connected_nodes: "+d.size());if(c.size()==d.size())a=!0;else{var e=c.diff(d).left;console.log("Disconnected:",e.size());console.log("left: "+e.map(function(a){return a.id()}).join(", "));e.addClass("disconnected");
setTimeout(function(){e.removeClass("disconnected")},3E3)}return a};
